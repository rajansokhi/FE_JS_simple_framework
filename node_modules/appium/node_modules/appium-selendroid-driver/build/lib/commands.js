'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _utf7 = require('utf7');

var _utf72 = _interopRequireDefault(_utf7);

var _appiumAndroidDriver = require('appium-android-driver');

var _driver = require('./driver');

var imap = _utf72['default'].imap;

var extensions = {},
    commands = {},
    helpers = {};

commands.launchApp = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.startSelendroidSession());

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};
commands.reset = function callee$0$0() {
  var oldImpWait, oldCommandTimeoutMs, oldSessionId;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug("Running generic full reset");
        oldImpWait = this.implicitWaitMs;
        oldCommandTimeoutMs = this.commandTimeoutMs;
        oldSessionId = this.sessionId;
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.deleteSession());

      case 6:
        _logger2['default'].debug("Restarting app");
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.startSelendroidSession());

      case 9:
        this.implicitWait(oldImpWait);
        this.timeouts('command', oldCommandTimeoutMs);
        this.sessionId = oldSessionId;

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.performMultiAction = function callee$0$0(elId, actions) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!elId) {
          context$1$0.next = 2;
          break;
        }

        throw new Error("Selendroid actions do not support element id");

      case 2:
        return context$1$0.abrupt('return', this.selendroid.jwproxy.command('/action', 'POST', { payload: actions }));

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

function encodeString(value, unicode) {
  for (var i = 0; i < value.length; i++) {
    var c = value.charCodeAt(i);
    // if we're using the unicode keyboard, and this is unicode, maybe encode
    if (unicode && (c > 127 || c === 38)) {
      // this is not simple ascii, or it is an ampersand (`&`)
      if (c >= parseInt("E000", 16) && c <= parseInt("E040", 16)) {
        // Selenium uses a Unicode PUA to cover certain special characters
        // see https://code.google.com/p/selenium/source/browse/java/client/src/org/openqa/selenium/Keys.java
      } else {
          // encode the text
          value = imap.encode(value);
          break;
        }
    }
  }
  return value;
}

// Need to override this for correct unicode support
commands.setValue = function callee$0$0(value, elementId) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (value instanceof Array) {
          value = value.join("");
        }
        _logger2['default'].debug('Setting text on element \'' + elementId + '\': \'' + value + '\'');
        value = encodeString(value, this.opts.unicodeKeyboard);
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.selendroid.jwproxy.command('/element/' + elementId + '/value', 'POST', { value: [value] }));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

// Need to override this for correct unicode support
commands.keys = function callee$0$0(value) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (value instanceof Array) {
          value = value.join("");
        }
        _logger2['default'].debug('Setting text: \'' + value + '\'');
        value = encodeString(value, this.opts.unicodeKeyboard);
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.selendroid.jwproxy.command('/keys', 'POST', { value: [value] }));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

// Selendroid doesn't support metastate for keyevents
commands.keyevent = function callee$0$0(keycode, metastate) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Ignoring metastate ' + metastate);
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.adb.keyevent(keycode));

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

// Use ADB since we don't have UiAutomator
commands.back = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.adb.keyevent(4));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getContexts = function callee$0$0() {
  var chromiumViews, webviews, selendroidViews;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        chromiumViews = [];
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumAndroidDriver.webviewHelpers.getWebviews(this.adb, this.opts.androidDeviceSocket));

      case 3:
        webviews = context$1$0.sent;

        if (_lodash2['default'].contains(webviews, _appiumAndroidDriver.CHROMIUM_WIN)) {
          chromiumViews = [_appiumAndroidDriver.CHROMIUM_WIN];
        } else {
          chromiumViews = [];
        }

        _logger2['default'].info('Getting window handles from Selendroid');
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.selendroid.jwproxy.command('/window_handles', 'GET', {}));

      case 8:
        selendroidViews = context$1$0.sent;

        this.contexts = _lodash2['default'].union(selendroidViews, chromiumViews);
        _logger2['default'].info('Available contexts: ' + JSON.stringify(this.contexts));
        return context$1$0.abrupt('return', this.contexts);

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.switchContext = function callee$0$0(name) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.selendroid.jwproxy.command('/window', 'POST', { name: name }));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.isChromedriverContext = function (windowName) {
  return windowName === _appiumAndroidDriver.CHROMIUM_WIN;
};

// Need to override android-driver's version of this since we don't actually
// have a bootstrap; instead we just restart adb and re-forward the Selendroid
// port
helpers.wrapBootstrapDisconnect = function callee$0$0(wrapped) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(wrapped());

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.adb.restart());

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.adb.forwardPort(this.opts.systemPort, _driver.DEVICE_PORT));

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands, helpers);

exports['default'] = extensions;
module.exports = exports['default'];

// called when setting context
//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUNMLHVCQUFhLEdBQUcsRUFBRSxDQUFDO1NBQ3BCOztBQUVELDRCQUFJLElBQUksQ0FBQyx3Q0FBd0MsQ0FBQyxDQUFDOzt5Q0FDdkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLGlCQUFpQixFQUFFLEtBQUssRUFBRSxFQUFFLENBQUM7OztBQUFyRix1QkFBZTs7QUFDbkIsWUFBSSxDQUFDLFFBQVEsR0FBRyxvQkFBRSxLQUFLLENBQUMsZUFBZSxFQUFFLGFBQWEsQ0FBQyxDQUFDO0FBQ3hELDRCQUFJLElBQUksMEJBQXdCLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFHLENBQUM7NENBQzFELElBQUksQ0FBQyxRQUFROzs7Ozs7O0NBQ3JCLENBQUM7O0FBRUYsT0FBTyxDQUFDLGFBQWEsR0FBRyxvQkFBZ0IsSUFBSTs7Ozs7eUNBRXBDLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsTUFBTSxFQUFFLEVBQUMsSUFBSSxFQUFKLElBQUksRUFBQyxDQUFDOzs7Ozs7O0NBQ2pFLENBQUM7O0FBRUYsT0FBTyxDQUFDLHFCQUFxQixHQUFHLFVBQVUsVUFBVSxFQUFFO0FBQ3BELFNBQU8sVUFBVSxzQ0FBaUIsQ0FBQztDQUNwQyxDQUFDOzs7OztBQUtGLE9BQU8sQ0FBQyx1QkFBdUIsR0FBRyxvQkFBZ0IsT0FBTzs7Ozs7eUNBQ2pELE9BQU8sRUFBRTs7Ozt5Q0FDVCxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRTs7Ozt5Q0FDbEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLHNCQUFjOzs7Ozs7O0NBQzlELENBQUM7O0FBRUYsZUFBYyxVQUFVLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDOztxQkFFOUIsVUFBVSIsImZpbGUiOiJsaWIvY29tbWFuZHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgdXRmNyBmcm9tICd1dGY3JztcbmltcG9ydCB7IHdlYnZpZXdIZWxwZXJzLCBDSFJPTUlVTV9XSU4gfSBmcm9tICdhcHBpdW0tYW5kcm9pZC1kcml2ZXInO1xuaW1wb3J0IHsgREVWSUNFX1BPUlQgfSBmcm9tICcuL2RyaXZlcic7XG5cbmNvbnN0IHtpbWFwfSA9IHV0Zjc7XG5cbmxldCBleHRlbnNpb25zID0ge30sXG4gICAgY29tbWFuZHMgPSB7fSxcbiAgICBoZWxwZXJzID0ge307XG5cbmNvbW1hbmRzLmxhdW5jaEFwcCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgYXdhaXQgdGhpcy5zdGFydFNlbGVuZHJvaWRTZXNzaW9uKCk7XG59O1xuY29tbWFuZHMucmVzZXQgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxvZy5kZWJ1ZyhcIlJ1bm5pbmcgZ2VuZXJpYyBmdWxsIHJlc2V0XCIpO1xuICBsZXQgb2xkSW1wV2FpdCA9IHRoaXMuaW1wbGljaXRXYWl0TXM7XG4gIGxldCBvbGRDb21tYW5kVGltZW91dE1zID0gdGhpcy5jb21tYW5kVGltZW91dE1zO1xuICBsZXQgb2xkU2Vzc2lvbklkID0gdGhpcy5zZXNzaW9uSWQ7XG5cbiAgYXdhaXQgdGhpcy5kZWxldGVTZXNzaW9uKCk7XG4gIGxvZy5kZWJ1ZyhcIlJlc3RhcnRpbmcgYXBwXCIpO1xuICBhd2FpdCB0aGlzLnN0YXJ0U2VsZW5kcm9pZFNlc3Npb24oKTtcbiAgdGhpcy5pbXBsaWNpdFdhaXQob2xkSW1wV2FpdCk7XG4gIHRoaXMudGltZW91dHMoJ2NvbW1hbmQnLCBvbGRDb21tYW5kVGltZW91dE1zKTtcbiAgdGhpcy5zZXNzaW9uSWQgPSBvbGRTZXNzaW9uSWQ7XG59O1xuXG5jb21tYW5kcy5wZXJmb3JtTXVsdGlBY3Rpb24gPSBhc3luYyBmdW5jdGlvbiAoZWxJZCwgYWN0aW9ucykge1xuICBpZiAoZWxJZCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIlNlbGVuZHJvaWQgYWN0aW9ucyBkbyBub3Qgc3VwcG9ydCBlbGVtZW50IGlkXCIpO1xuICB9XG4gIHJldHVybiB0aGlzLnNlbGVuZHJvaWQuandwcm94eS5jb21tYW5kKCcvYWN0aW9uJywgJ1BPU1QnLCB7cGF5bG9hZDogYWN0aW9uc30pO1xufTtcblxuZnVuY3Rpb24gZW5jb2RlU3RyaW5nICh2YWx1ZSwgdW5pY29kZSkge1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSsrKSB7XG4gICAgbGV0IGMgPSB2YWx1ZS5jaGFyQ29kZUF0KGkpO1xuICAgIC8vIGlmIHdlJ3JlIHVzaW5nIHRoZSB1bmljb2RlIGtleWJvYXJkLCBhbmQgdGhpcyBpcyB1bmljb2RlLCBtYXliZSBlbmNvZGVcbiAgICBpZiAodW5pY29kZSAmJiAoYyA+IDEyNyB8fCBjID09PSAzOCkpIHtcbiAgICAgIC8vIHRoaXMgaXMgbm90IHNpbXBsZSBhc2NpaSwgb3IgaXQgaXMgYW4gYW1wZXJzYW5kIChgJmApXG4gICAgICBpZiAoYyA+PSBwYXJzZUludChcIkUwMDBcIiwgMTYpICYmIGMgPD0gcGFyc2VJbnQoXCJFMDQwXCIsIDE2KSkge1xuICAgICAgICAvLyBTZWxlbml1bSB1c2VzIGEgVW5pY29kZSBQVUEgdG8gY292ZXIgY2VydGFpbiBzcGVjaWFsIGNoYXJhY3RlcnNcbiAgICAgICAgLy8gc2VlIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3Avc2VsZW5pdW0vc291cmNlL2Jyb3dzZS9qYXZhL2NsaWVudC9zcmMvb3JnL29wZW5xYS9zZWxlbml1bS9LZXlzLmphdmFcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIGVuY29kZSB0aGUgdGV4dFxuICAgICAgICB2YWx1ZSA9IGltYXAuZW5jb2RlKHZhbHVlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiB2YWx1ZTtcbn1cblxuLy8gTmVlZCB0byBvdmVycmlkZSB0aGlzIGZvciBjb3JyZWN0IHVuaWNvZGUgc3VwcG9ydFxuY29tbWFuZHMuc2V0VmFsdWUgPSBhc3luYyBmdW5jdGlvbiAodmFsdWUsIGVsZW1lbnRJZCkge1xuICBpZiAodmFsdWUgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgIHZhbHVlID0gdmFsdWUuam9pbihcIlwiKTtcbiAgfVxuICBsb2cuZGVidWcoYFNldHRpbmcgdGV4dCBvbiBlbGVtZW50ICcke2VsZW1lbnRJZH0nOiAnJHt2YWx1ZX0nYCk7XG4gIHZhbHVlID0gZW5jb2RlU3RyaW5nKHZhbHVlLCB0aGlzLm9wdHMudW5pY29kZUtleWJvYXJkKTtcbiAgYXdhaXQgdGhpcy5zZWxlbmRyb2lkLmp3cHJveHkuY29tbWFuZChgL2VsZW1lbnQvJHtlbGVtZW50SWR9L3ZhbHVlYCwgJ1BPU1QnLCB7dmFsdWU6IFt2YWx1ZV19KTtcbn07XG5cbi8vIE5lZWQgdG8gb3ZlcnJpZGUgdGhpcyBmb3IgY29ycmVjdCB1bmljb2RlIHN1cHBvcnRcbmNvbW1hbmRzLmtleXMgPSBhc3luYyBmdW5jdGlvbiAodmFsdWUpIHtcbiAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICB2YWx1ZSA9IHZhbHVlLmpvaW4oXCJcIik7XG4gIH1cbiAgbG9nLmRlYnVnKGBTZXR0aW5nIHRleHQ6ICcke3ZhbHVlfSdgKTtcbiAgdmFsdWUgPSBlbmNvZGVTdHJpbmcodmFsdWUsIHRoaXMub3B0cy51bmljb2RlS2V5Ym9hcmQpO1xuICBhd2FpdCB0aGlzLnNlbGVuZHJvaWQuandwcm94eS5jb21tYW5kKCcva2V5cycsICdQT1NUJywge3ZhbHVlOiBbdmFsdWVdfSk7XG59O1xuXG4vLyBTZWxlbmRyb2lkIGRvZXNuJ3Qgc3VwcG9ydCBtZXRhc3RhdGUgZm9yIGtleWV2ZW50c1xuY29tbWFuZHMua2V5ZXZlbnQgPSBhc3luYyBmdW5jdGlvbiAoa2V5Y29kZSwgbWV0YXN0YXRlKSB7XG4gIGxvZy5kZWJ1ZyhgSWdub3JpbmcgbWV0YXN0YXRlICR7bWV0YXN0YXRlfWApO1xuICBhd2FpdCB0aGlzLmFkYi5rZXlldmVudChrZXljb2RlKTtcbn07XG5cbi8vIFVzZSBBREIgc2luY2Ugd2UgZG9uJ3QgaGF2ZSBVaUF1dG9tYXRvclxuY29tbWFuZHMuYmFjayA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgYXdhaXQgdGhpcy5hZGIua2V5ZXZlbnQoNCk7XG59O1xuXG5jb21tYW5kcy5nZXRDb250ZXh0cyA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbGV0IGNocm9taXVtVmlld3MgPSBbXTtcbiAgbGV0IHdlYnZpZXdzID0gYXdhaXQgd2Vidmlld0hlbHBlcnMuZ2V0V2Vidmlld3ModGhpcy5hZGIsXG4gICAgICB0aGlzLm9wdHMuYW5kcm9pZERldmljZVNvY2tldCk7XG4gIGlmIChfLmNvbnRhaW5zKHdlYnZpZXdzLCBDSFJPTUlVTV9XSU4pKSB7XG4gICAgY2hyb21pdW1WaWV3cyA9IFtDSFJPTUlVTV9XSU5dO1xuICB9IGVsc2Uge1xuICAgIGNocm9taXVtVmlld3MgPSBbXTtcbiAgfVxuXG4gIGxvZy5pbmZvKCdHZXR0aW5nIHdpbmRvdyBoYW5kbGVzIGZyb20gU2VsZW5kcm9pZCcpO1xuICBsZXQgc2VsZW5kcm9pZFZpZXdzID0gYXdhaXQgdGhpcy5zZWxlbmRyb2lkLmp3cHJveHkuY29tbWFuZCgnL3dpbmRvd19oYW5kbGVzJywgJ0dFVCcsIHt9KTtcbiAgdGhpcy5jb250ZXh0cyA9IF8udW5pb24oc2VsZW5kcm9pZFZpZXdzLCBjaHJvbWl1bVZpZXdzKTtcbiAgbG9nLmluZm8oYEF2YWlsYWJsZSBjb250ZXh0czogJHtKU09OLnN0cmluZ2lmeSh0aGlzLmNvbnRleHRzKX1gKTtcbiAgcmV0dXJuIHRoaXMuY29udGV4dHM7XG59O1xuXG5oZWxwZXJzLnN3aXRjaENvbnRleHQgPSBhc3luYyBmdW5jdGlvbiAobmFtZSkge1xuICAvLyBjYWxsZWQgd2hlbiBzZXR0aW5nIGNvbnRleHRcbiAgYXdhaXQgdGhpcy5zZWxlbmRyb2lkLmp3cHJveHkuY29tbWFuZCgnL3dpbmRvdycsICdQT1NUJywge25hbWV9KTtcbn07XG5cbmhlbHBlcnMuaXNDaHJvbWVkcml2ZXJDb250ZXh0ID0gZnVuY3Rpb24gKHdpbmRvd05hbWUpIHtcbiAgcmV0dXJuIHdpbmRvd05hbWUgPT09IENIUk9NSVVNX1dJTjtcbn07XG5cbi8vIE5lZWQgdG8gb3ZlcnJpZGUgYW5kcm9pZC1kcml2ZXIncyB2ZXJzaW9uIG9mIHRoaXMgc2luY2Ugd2UgZG9uJ3QgYWN0dWFsbHlcbi8vIGhhdmUgYSBib290c3RyYXA7IGluc3RlYWQgd2UganVzdCByZXN0YXJ0IGFkYiBhbmQgcmUtZm9yd2FyZCB0aGUgU2VsZW5kcm9pZFxuLy8gcG9ydFxuaGVscGVycy53cmFwQm9vdHN0cmFwRGlzY29ubmVjdCA9IGFzeW5jIGZ1bmN0aW9uICh3cmFwcGVkKSB7XG4gIGF3YWl0IHdyYXBwZWQoKTtcbiAgYXdhaXQgdGhpcy5hZGIucmVzdGFydCgpO1xuICBhd2FpdCB0aGlzLmFkYi5mb3J3YXJkUG9ydCh0aGlzLm9wdHMuc3lzdGVtUG9ydCwgREVWSUNFX1BPUlQpO1xufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5cbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
