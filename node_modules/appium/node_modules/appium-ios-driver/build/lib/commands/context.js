'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _asyncbox = require('asyncbox');

var _appiumRemoteDebugger = require('appium-remote-debugger');

var _deviceLogIosPerformanceLog = require('../device-log/ios-performance-log');

var _appiumBaseDriver = require('appium-base-driver');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumSupport = require('appium-support');

var NATIVE_WIN = 'NATIVE_APP';
var WEBVIEW_WIN = 'WEBVIEW';
var WEBVIEW_BASE = WEBVIEW_WIN + '_';

var commands = {},
    helpers = {},
    extensions = {};

commands.getCurrentContext = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(this.curContext && this.curContext !== NATIVE_WIN)) {
          context$1$0.next = 4;
          break;
        }

        return context$1$0.abrupt('return', '' + WEBVIEW_BASE + this.curContext);

      case 4:
        return context$1$0.abrupt('return', NATIVE_WIN);

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getContexts = function callee$0$0() {
  var contexts;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Getting list of available contexts');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.getContextsAndViews(false));

      case 3:
        contexts = context$1$0.sent;
        return context$1$0.abrupt('return', contexts.map(function (context) {
          return context.id.toString();
        }));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setContext = function callee$0$0(name, callback, skipReadyCheck) {
  var alreadyInContext, contextId, _$map, _$map2, appIdKey, pageIdKey;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        alreadyInContext = function alreadyInContext(desired, current) {
          return desired === current || desired === null && current === NATIVE_WIN || desired === NATIVE_WIN && current === null;
        };

        _logger2['default'].debug('Attempting to set context to \'' + name + '\'');

        if (!alreadyInContext(name, this.curContext)) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 33;
        break;

      case 5:
        if (!(name === NATIVE_WIN || name === null)) {
          context$1$0.next = 10;
          break;
        }

        // switching into the native context
        this.curContext = null;
        if (this.isRealDevice()) {
          this.remote.disconnect();
        }
        context$1$0.next = 33;
        break;

      case 10:
        if (!_lodash2['default'].isUndefined(this.contexts)) {
          context$1$0.next = 13;
          break;
        }

        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(this.getContexts());

      case 13:
        contextId = name.replace(WEBVIEW_BASE, '');

        if (contextId === '') {
          // allow user to pass in "WEBVIEW" without an index
          // the second context will be the first webview as
          // the first is always NATIVE_APP
          contextId = this.contexts[1];
        }

        if (_lodash2['default'].includes(this.contexts, contextId)) {
          context$1$0.next = 17;
          break;
        }

        throw new _appiumBaseDriver.errors.NoSuchContextError();

      case 17:
        if (!this.isRealDevice()) {
          context$1$0.next = 26;
          break;
        }

        if (!this.remote) {
          context$1$0.next = 21;
          break;
        }

        context$1$0.next = 21;
        return _regeneratorRuntime.awrap(this.remote.disconnect());

      case 21:
        this.curContext = contextId;
        context$1$0.next = 24;
        return _regeneratorRuntime.awrap(this.remote.connect(contextId));

      case 24:
        context$1$0.next = 33;
        break;

      case 26:
        _$map = _lodash2['default'].map(contextId.split('.'), function (id) {
          return parseInt(id, 10);
        });
        _$map2 = _slicedToArray(_$map, 2);
        appIdKey = _$map2[0];
        pageIdKey = _$map2[1];
        context$1$0.next = 32;
        return _regeneratorRuntime.awrap(this.remote.selectPage(appIdKey, pageIdKey, skipReadyCheck));

      case 32:
        this.curContext = contextId;

      case 33:

        // attempt to start performance logging, if requested
        if (this.perfLogEnabled && this.remote) {
          _logger2['default'].debug('Starting performance log on \'' + this.curContext + '\'');
          this.logs.performance = new _deviceLogIosPerformanceLog.IOSPerformanceLog(this.remote);
          this.logs.performance.startCapture();
        }

      case 34:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getWindowHandle = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotImplementedError();

      case 2:
        return context$1$0.abrupt('return', this.curContext.toString());

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getWindowHandles = function callee$0$0() {
  var pageArray, idArray;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotImplementedError();

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.listWebFrames());

      case 4:
        pageArray = context$1$0.sent;

        this.windowHandleCache = _lodash2['default'].map(pageArray, this.massagePage);
        idArray = _lodash2['default'].map(this.windowHandleCache, 'id');

        // since we use this.contexts to manage selecting debugger pages, make
        // sure it gets populated even if someone did not use the
        // getContexts method
        if (!this.contexts) {
          this.contexts = idArray;
        }
        return context$1$0.abrupt('return', _lodash2['default'].map(idArray, function (id) {
          return id.toString();
        }));

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setWindow = function callee$0$0(name, skipReadyCheck) {
  var pageIdKey;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotImplementedError();

      case 2:
        if (_lodash2['default'].includes(_lodash2['default'].map(this.windowHandleCache, 'id'), name)) {
          context$1$0.next = 4;
          break;
        }

        throw new _appiumBaseDriver.errors.NoSuchWindowError();

      case 4:
        pageIdKey = parseInt(name, 10);

        if (this.isRealDevice()) {
          context$1$0.next = 11;
          break;
        }

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.remote.selectPage(pageIdKey, skipReadyCheck));

      case 8:
        this.curContext = this.curWindowHandle = name;
        context$1$0.next = 24;
        break;

      case 11:
        if (!(name === this.curWindowHandle)) {
          context$1$0.next = 15;
          break;
        }

        _logger2['default'].debug('Remote debugger is already connected to window \'' + name + '\'');
        context$1$0.next = 24;
        break;

      case 15:
        if (_lodash2['default'].includes(_lodash2['default'].map(this.windowHandleCache, 'id'), name)) {
          context$1$0.next = 19;
          break;
        }

        throw new _appiumBaseDriver.errors.NoSuchWindowError();

      case 19:
        context$1$0.next = 21;
        return _regeneratorRuntime.awrap(this.remote.disconnect());

      case 21:
        this.curContext = this.curWindowHandle = name;
        context$1$0.next = 24;
        return _regeneratorRuntime.awrap(this.remote.connect(name));

      case 24:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.webContextIndex = function () {
  return this.curContext.replace(WEBVIEW_BASE, '') - 1;
};

extensions.initAutoWebview = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.opts.autoWebview) {
          context$1$0.next = 4;
          break;
        }

        _logger2['default'].debug('Setting auto webview');
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.navToInitialWebview(this));

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.getContextsAndViews = function callee$0$0() {
  var useUrl = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];

  var webviews, ctxs, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, view;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Retrieving contexts and views');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.listWebFrames(useUrl));

      case 3:
        webviews = context$1$0.sent;
        ctxs = [{ id: NATIVE_WIN }];

        this.contexts = [NATIVE_WIN];
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 9;
        for (_iterator = _getIterator(webviews); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          view = _step.value;

          ctxs.push({ id: '' + WEBVIEW_BASE + view.id, view: view });
          this.contexts.push(view.id.toString());
        }
        context$1$0.next = 17;
        break;

      case 13:
        context$1$0.prev = 13;
        context$1$0.t0 = context$1$0['catch'](9);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 17:
        context$1$0.prev = 17;
        context$1$0.prev = 18;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 20:
        context$1$0.prev = 20;

        if (!_didIteratorError) {
          context$1$0.next = 23;
          break;
        }

        throw _iteratorError;

      case 23:
        return context$1$0.finish(20);

      case 24:
        return context$1$0.finish(17);

      case 25:
        return context$1$0.abrupt('return', ctxs);

      case 26:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[9, 13, 17, 25], [18,, 20, 24]]);
};

extensions.listWebFrames = function callee$0$0() {
  var useUrl = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];
  var currentUrl, pageArray, appInfo, tryClosingAlert;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.opts.bundleId) {
          _logger2['default'].errorAndThrow('Cannot enter web frame without a bundle ID');
        }

        useUrl = useUrl && !!this.getCurrentUrl();
        /* jshint ignore:start */
        _logger2['default'].debug('Selecting by url: ' + useUrl + ' ' + (useUrl ? '(expected url: \'' + this.getCurrentUrl() + '\')' : ''));
        /* jshint ignore:end */

        currentUrl = useUrl ? this.getCurrentUrl() : undefined;
        pageArray = undefined;

        if (!(this.isRealDevice() && this.remote && this.opts.bundleId)) {
          context$1$0.next = 11;
          break;
        }

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.remote.pageArrayFromJson());

      case 8:
        pageArray = context$1$0.sent;
        context$1$0.next = 54;
        break;

      case 11:
        if (!(this.remote && this.remote.appIdKey)) {
          context$1$0.next = 17;
          break;
        }

        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(this.remote.selectApp(currentUrl, this.opts.webviewConnectRetries));

      case 14:
        pageArray = context$1$0.sent;
        context$1$0.next = 54;
        break;

      case 17:
        if (!this.isRealDevice()) {
          context$1$0.next = 34;
          break;
        }

        context$1$0.prev = 18;

        this.remote = new _appiumRemoteDebugger.WebKitRemoteDebugger({ port: this.opts.webkitDebugProxyPort });
        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(this.remote.pageArrayFromJson());

      case 22:
        pageArray = context$1$0.sent;
        context$1$0.next = 32;
        break;

      case 25:
        context$1$0.prev = 25;
        context$1$0.t0 = context$1$0['catch'](18);

        if (_lodash2['default'].includes(context$1$0.t0.message, 'connect ECONNREFUSED')) {
          context$1$0.next = 29;
          break;
        }

        throw context$1$0.t0;

      case 29:

        _logger2['default'].warn('Attempted to get a list of webview contexts but could not connect to ' + 'ios-webkit-debug-proxy. If you expect to find webviews, please ensure ' + 'that the proxy is running and accessible');
        this.remote = null;
        pageArray = [];

      case 32:
        context$1$0.next = 54;
        break;

      case 34:
        // simulator, and not connected
        this.remote = new _appiumRemoteDebugger.RemoteDebugger({
          bundleId: this.opts.bundleId,
          useNewSafari: this.useNewSafari(),
          pageLoadMs: this.pageLoadMs,
          platformVersion: this.opts.platformVersion
        });

        context$1$0.next = 37;
        return _regeneratorRuntime.awrap(this.remote.connect());

      case 37:
        appInfo = context$1$0.sent;

        if (appInfo) {
          context$1$0.next = 41;
          break;
        }

        _logger2['default'].debug('Unable to connect to the remote debugger.');
        return context$1$0.abrupt('return', []);

      case 41:
        context$1$0.next = 43;
        return _regeneratorRuntime.awrap(this.remote.selectApp(currentUrl, this.opts.webviewConnectRetries));

      case 43:
        pageArray = context$1$0.sent;

        this.remote.on(_appiumRemoteDebugger.RemoteDebugger.EVENT_PAGE_CHANGE, this.onPageChange.bind(this));

        tryClosingAlert = function tryClosingAlert() {
          var didDismiss;
          return _regeneratorRuntime.async(function tryClosingAlert$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap(this.closeAlertBeforeTest());

              case 2:
                didDismiss = context$2$0.sent;

                if (didDismiss) {
                  context$2$0.next = 5;
                  break;
                }

                throw new Error('Close alert failed. Retry.');

              case 5:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        };

        context$1$0.prev = 46;
        context$1$0.next = 49;
        return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(3, 4000, tryClosingAlert));

      case 49:
        context$1$0.next = 54;
        break;

      case 51:
        context$1$0.prev = 51;
        context$1$0.t1 = context$1$0['catch'](46);

        // if the loop to close alerts failed to dismiss, ignore,
        // otherwise log and throw the error
        if (context$1$0.t1.message !== 'Close alert failed. Retry.') {
          _logger2['default'].errorAndThrow(context$1$0.t1);
        }

      case 54:

        if (pageArray.length === 0) {
          // we have no web frames, but continue anyway
          _logger2['default'].debug('No web frames found.');
        }
        return context$1$0.abrupt('return', pageArray);

      case 56:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[18, 25], [46, 51]]);
};

extensions.onPageChange = function callee$0$0(pageChangeNotification) {
  var appIdKey, pageArray, newIds, newPages, keyId, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, page, id, contextId, newPage, _curContext$split, _curContext$split2, curAppIdKey, curPageIdKey, needsPageLoad;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this2 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Remote debugger notified us of a new page listing: ' + JSON.stringify(pageChangeNotification));

        if (!this.selectingNewPage) {
          context$1$0.next = 4;
          break;
        }

        _logger2['default'].debug('We are in the middle of selecting a page, ignoring');
        return context$1$0.abrupt('return');

      case 4:
        if (this.remote.appIdKey) {
          context$1$0.next = 7;
          break;
        }

        _logger2['default'].debug('We have not yet connected, ignoring');
        return context$1$0.abrupt('return');

      case 7:
        appIdKey = pageChangeNotification.appIdKey;
        pageArray = pageChangeNotification.pageArray;
        newIds = [];
        newPages = [];
        keyId = null;
        _iteratorNormalCompletion2 = true;
        _didIteratorError2 = false;
        _iteratorError2 = undefined;
        context$1$0.prev = 15;

        for (_iterator2 = _getIterator(pageArray); !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
          page = _step2.value;
          id = page.id.toString();

          newIds.push(id);
          if (page.isKey) {
            keyId = id;
          }
          contextId = appIdKey + '.' + id;

          if (!_lodash2['default'].includes(this.contexts, contextId)) {
            newPages.push(id);
            this.contexts.push(contextId);
          }
        }

        context$1$0.next = 23;
        break;

      case 19:
        context$1$0.prev = 19;
        context$1$0.t0 = context$1$0['catch'](15);
        _didIteratorError2 = true;
        _iteratorError2 = context$1$0.t0;

      case 23:
        context$1$0.prev = 23;
        context$1$0.prev = 24;

        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }

      case 26:
        context$1$0.prev = 26;

        if (!_didIteratorError2) {
          context$1$0.next = 29;
          break;
        }

        throw _iteratorError2;

      case 29:
        return context$1$0.finish(26);

      case 30:
        return context$1$0.finish(23);

      case 31:
        if (!keyId) {
          // if there is no key id, pull the first id from the page array and use that
          // as a stand in
          _logger2['default'].debug('No key id found. Choosing first id from page array');
          keyId = newIds[0] || null;
        }

        newPage = null;

        if (!(this.curContext === null)) {
          context$1$0.next = 37;
          break;
        }

        _logger2['default'].debug('We do not appear to have window set yet, ignoring');
        context$1$0.next = 69;
        break;

      case 37:
        _curContext$split = this.curContext.split('.');
        _curContext$split2 = _slicedToArray(_curContext$split, 2);
        curAppIdKey = _curContext$split2[0];
        curPageIdKey = _curContext$split2[1];

        if (!(curAppIdKey !== appIdKey)) {
          context$1$0.next = 44;
          break;
        }

        _logger2['default'].debug('Page change not referring to currently selected app, ignoring.');
        return context$1$0.abrupt('return');

      case 44:
        if (!newPages.length) {
          context$1$0.next = 49;
          break;
        }

        newPage = _lodash2['default'].last(newPages);
        _logger2['default'].debug('We have new pages, going to select page \'' + newPage + '\'');
        context$1$0.next = 69;
        break;

      case 49:
        if (_lodash2['default'].includes(newIds, curPageIdKey)) {
          context$1$0.next = 62;
          break;
        }

        _logger2['default'].debug('New page listing from remote debugger does not contain ' + 'current window; assuming it is closed');

        if (!(keyId !== null)) {
          context$1$0.next = 55;
          break;
        }

        _logger2['default'].debug('Debugger already selected page \'' + keyId + '\', ' + 'confirming that choice.');
        context$1$0.next = 58;
        break;

      case 55:
        _logger2['default'].error('Do not have our current window anymore, and there ' + 'are not any more to load! Doing nothing...');
        this.setCurrentUrl(undefined);
        return context$1$0.abrupt('return');

      case 58:
        this.curContext = appIdKey + '.' + keyId;
        newPage = keyId;
        context$1$0.next = 69;
        break;

      case 62:
        _logger2['default'].debug('Checking if page needs to load');
        // If a window navigates to an anchor it doesn't always fire a page
        // callback event. Let's check if we wound up in such a situation.

        needsPageLoad = (function () {
          var item = function item(arr) {
            return _lodash2['default'].filter(arr, function (obj) {
              return obj.id === _this2.curContext;
            })[0];
          };

          // need to map the page ids to context ids
          var contextArray = _lodash2['default'].map(pageArray, function (arr) {
            return { id: appIdKey + '.' + arr.id };
          });
          return !_lodash2['default'].isEqual(item(_this2.contexts), item(contextArray));
        })();

        if (!needsPageLoad) {
          context$1$0.next = 68;
          break;
        }

        _logger2['default'].debug('Page load needed. Loading.');
        context$1$0.next = 68;
        return _regeneratorRuntime.awrap(this.remote.pageLoad());

      case 68:

        _logger2['default'].debug('New page listing is same as old, doing nothing');

      case 69:

        // make sure that the page listing isn't indicating a redirect
        if (_appiumSupport.util.hasValue(this.curContext)) {
          (function () {
            var currentPageId = parseInt(_lodash2['default'].last(_this2.curContext.split('.')), 10);
            var page = _lodash2['default'].find(pageArray, function (p) {
              return parseInt(p.id, 10) === currentPageId;
            });
            if (page && page.url !== _this2.getCurrentUrl()) {
              _logger2['default'].debug('Redirected from \'' + _this2.getCurrentUrl() + '\' to \'' + page.url + '\'');
              _this2.setCurrentUrl(page.url);
            }
          })();
        }

        if (!_appiumSupport.util.hasValue(newPage)) {
          context$1$0.next = 76;
          break;
        }

        this.selectingNewPage = true;
        context$1$0.next = 74;
        return _regeneratorRuntime.awrap(this.remote.selectPage(appIdKey, parseInt(newPage, 10)));

      case 74:
        this.selectingNewPage = false;
        this.curContext = appIdKey + '.' + newPage;

      case 76:
        this.windowHandleCache = _lodash2['default'].map(pageArray, this.massagePage);

      case 77:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[15, 19, 23, 31], [24,, 26, 30]]);
};

extensions.getLatestWebviewContextForTitle = function callee$0$0(regExp) {
  var contexts, matchingCtx, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, ctx;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.getContextsAndViews());

      case 2:
        contexts = context$1$0.sent;
        matchingCtx = undefined;
        _iteratorNormalCompletion3 = true;
        _didIteratorError3 = false;
        _iteratorError3 = undefined;
        context$1$0.prev = 7;
        _iterator3 = _getIterator(contexts);

      case 9:
        if (_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done) {
          context$1$0.next = 17;
          break;
        }

        ctx = _step3.value;

        if (!(ctx.view && ((ctx.view.title || '').match(regExp) || (ctx.view.url || '').match(regExp)))) {
          context$1$0.next = 14;
          break;
        }

        if (ctx.view.url !== 'about:blank') {
          matchingCtx = ctx;
        } else {
          // in the cases of Xcode < 5 (i.e., iOS SDK Version less than 7)
          // iOS 7.1, iOS 9.0 & iOS 9.1 in a webview (not in Safari)
          // we can have the url be `about:blank`
          if (parseFloat(this.iosSdkVersion) < 7 || parseFloat(this.iosSdkVersion) >= 9 || this.opts.platformVersion === '7.1' && this.opts.app && this.opts.app.toLowerCase() !== 'safari') {
            matchingCtx = ctx;
          }
        }
        return context$1$0.abrupt('break', 17);

      case 14:
        _iteratorNormalCompletion3 = true;
        context$1$0.next = 9;
        break;

      case 17:
        context$1$0.next = 23;
        break;

      case 19:
        context$1$0.prev = 19;
        context$1$0.t0 = context$1$0['catch'](7);
        _didIteratorError3 = true;
        _iteratorError3 = context$1$0.t0;

      case 23:
        context$1$0.prev = 23;
        context$1$0.prev = 24;

        if (!_iteratorNormalCompletion3 && _iterator3['return']) {
          _iterator3['return']();
        }

      case 26:
        context$1$0.prev = 26;

        if (!_didIteratorError3) {
          context$1$0.next = 29;
          break;
        }

        throw _iteratorError3;

      case 29:
        return context$1$0.finish(26);

      case 30:
        return context$1$0.finish(23);

      case 31:
        return context$1$0.abrupt('return', matchingCtx ? matchingCtx.id : undefined);

      case 32:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[7, 19, 23, 31], [24,, 26, 30]]);
};

// Right now we don't necessarily wait for webview
// and frame to load, which leads to race conditions and flakiness,
// let's see if we can transition to something better
extensions.useNewSafari = function () {
  return parseFloat(this.iosSdkVersion) >= 8.1 && parseFloat(this.opts.platformVersion) >= 8.1 && !this.isRealDevice() && this.opts.safari;
};

extensions.navToInitialWebview = function callee$0$0() {
  var timeout;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        timeout = 0;

        if (this.isRealDevice()) {
          timeout = 3000;
          _logger2['default'].debug('Waiting for ' + timeout + ' ms before navigating to view.');
        }
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_bluebird2['default'].delay(timeout));

      case 4:
        if (!this.useNewSafari()) {
          context$1$0.next = 9;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.typeAndNavToUrl());

      case 7:
        context$1$0.next = 16;
        break;

      case 9:
        if (!(parseInt(this.iosSdkVersion, 10) >= 7 && !this.isRealDevice() && this.opts.safari)) {
          context$1$0.next = 14;
          break;
        }

        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(this.navToViewThroughFavorites());

      case 12:
        context$1$0.next = 16;
        break;

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.navToViewWithTitle(/.*/));

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

function openNewPage() {
  var newPageButton;
  return _regeneratorRuntime.async(function openNewPage$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.findElement('xpath', "//UIAButton[contains(@name,'New page')]"));

      case 2:
        newPageButton = context$1$0.sent;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.nativeTap(newPageButton.ELEMENT));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

extensions.typeAndNavToUrl = function callee$0$0() {
  var address, tries, MAX_TRIES, navigate;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this4 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        address = this.opts.address ? this.opts.address : '127.0.0.1';

        this.setCurrentUrl(this.caps.safariInitialUrl || 'http://' + address + ':' + this.opts.port + '/welcome');

        tries = 0;
        MAX_TRIES = 2;

        navigate = function navigate() {
          var oldImpWait, el, _el;

          return _regeneratorRuntime.async(function navigate$(context$2$0) {
            var _this3 = this;

            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                oldImpWait = this.implicitWaitMs;

                this.implicitWaitMs = 7000;

                // find the url bar, and tap on it. retry to make sure we don't try
                // too soon while the view is still loading
                context$2$0.next = 4;
                return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(3, 1000, function callee$2$0() {
                  return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                    while (1) switch (context$3$0.prev = context$3$0.next) {
                      case 0:
                        context$3$0.next = 2;
                        return _regeneratorRuntime.awrap(this.findElement('accessibility id', 'URL'));

                      case 2:
                        return context$3$0.abrupt('return', context$3$0.sent);

                      case 3:
                      case 'end':
                        return context$3$0.stop();
                    }
                  }, null, _this3);
                }));

              case 4:
                el = context$2$0.sent;

                this.implicitWaitMs = oldImpWait;

                context$2$0.prev = 6;
                context$2$0.next = 9;
                return _regeneratorRuntime.awrap(this.nativeTap(el.ELEMENT));

              case 9:
                context$2$0.next = 24;
                break;

              case 11:
                context$2$0.prev = 11;
                context$2$0.t0 = context$2$0['catch'](6);

                if (!_lodash2['default'].includes(context$2$0.t0.message, 'could not be tapped')) {
                  context$2$0.next = 23;
                  break;
                }

                if (!(tries++ >= MAX_TRIES)) {
                  context$2$0.next = 16;
                  break;
                }

                throw context$2$0.t0;

              case 16:
                context$2$0.next = 18;
                return _regeneratorRuntime.awrap(openNewPage());

              case 18:
                context$2$0.next = 20;
                return _regeneratorRuntime.awrap(navigate());

              case 20:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 23:
                throw context$2$0.t0;

              case 24:
                context$2$0.prev = 24;
                context$2$0.next = 27;
                return _regeneratorRuntime.awrap(this.findElement('class name', 'UIATextField'));

              case 27:
                _el = context$2$0.sent;
                context$2$0.next = 30;
                return _regeneratorRuntime.awrap(this.setValueImmediate(this.getCurrentUrl(), _el));

              case 30:
                context$2$0.next = 39;
                break;

              case 32:
                context$2$0.prev = 32;
                context$2$0.t1 = context$2$0['catch'](24);

                if (!(tries++ >= MAX_TRIES)) {
                  context$2$0.next = 36;
                  break;
                }

                throw context$2$0.t1;

              case 36:
                context$2$0.next = 38;
                return _regeneratorRuntime.awrap(navigate());

              case 38:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 39:
                context$2$0.prev = 39;
                context$2$0.next = 42;
                return _regeneratorRuntime.awrap(this.findElement('accessibility id', 'Go'));

              case 42:
                el = context$2$0.sent;
                context$2$0.next = 45;
                return _regeneratorRuntime.awrap(this.nativeTap(el.ELEMENT));

              case 45:
                context$2$0.next = 51;
                break;

              case 47:
                context$2$0.prev = 47;
                context$2$0.t2 = context$2$0['catch'](39);

                if (_lodash2['default'].includes(context$2$0.t2.message, 'could not be tapped')) {
                  _logger2['default'].error('Unable to submit URL because \'Go\' button could not be tapped. ' + 'Please make sure your keyboard is toggled on.');
                }
                throw context$2$0.t2;

              case 51:
                context$2$0.next = 53;
                return _regeneratorRuntime.awrap(this.navToViewWithTitle(undefined, new RegExp(this.getCurrentUrl(), 'i')));

              case 53:
                context$2$0.next = 55;
                return _regeneratorRuntime.awrap(this.remote.pageUnload());

              case 55:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this4, [[6, 11], [24, 32], [39, 47]]);
        };

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(navigate());

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.navToViewThroughFavorites = function callee$0$0() {
  var oldImpWait, el, msg;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('We are on iOS7+ simulator: clicking apple button to get into a webview');
        oldImpWait = this.implicitWaitMs;

        this.implicitWaitMs = 7000; // wait 7s for apple button to exist

        el = undefined;
        context$1$0.prev = 4;
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.findElement('xpath', '//UIAScrollView[1]/UIAButton[1]'));

      case 7:
        el = context$1$0.sent;
        context$1$0.next = 18;
        break;

      case 10:
        context$1$0.prev = 10;
        context$1$0.t0 = context$1$0['catch'](4);
        msg = 'Could not find button to click to get into webview. ' + 'Proceeding on the assumption we have a working one.';

        _logger2['default'].error(msg);
        this.implicitWaitMs = oldImpWait;
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap(this.navToViewWithTitle(/.*/i));

      case 17:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 18:
        this.implicitWaitMs = oldImpWait;
        context$1$0.prev = 19;
        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(this.nativeTap(el.ELEMENT));

      case 22:
        context$1$0.next = 28;
        break;

      case 24:
        context$1$0.prev = 24;
        context$1$0.t1 = context$1$0['catch'](19);
        msg = 'Could not click button to get into webview. ' + 'Proceeding on the assumption we have a working one.';

        _logger2['default'].error(msg);

      case 28:
        context$1$0.next = 30;
        return _regeneratorRuntime.awrap(this.navToViewWithTitle(/apple/i));

      case 30:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[4, 10], [19, 24]]);
};

extensions.navToViewWithTitle = function callee$0$0(titleRegex, urlRegExp) {
  var start, spinTime, spinHandles;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this5 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Navigating to most recently opened webview');
        start = Date.now();
        spinTime = 500;

        spinHandles = function spinHandles() {
          var res, latestWindow, element;
          return _regeneratorRuntime.async(function spinHandles$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                res = undefined;
                context$2$0.prev = 1;
                context$2$0.next = 4;
                return _regeneratorRuntime.awrap(this.getLatestWebviewContextForTitle(titleRegex || urlRegExp));

              case 4:
                res = context$2$0.sent;
                context$2$0.next = 12;
                break;

              case 7:
                context$2$0.prev = 7;
                context$2$0.t0 = context$2$0['catch'](1);

                if (!(context$2$0.t0.message.indexOf('Could not connect to a valid app after') === -1)) {
                  context$2$0.next = 11;
                  break;
                }

                throw new Error('Could not navigate to webview! Err: ' + context$2$0.t0.message);

              case 11:
                _logger2['default'].debug('Could not navigate to webview. Retrying if possible.');

              case 12:
                if (!res) {
                  context$2$0.next = 20;
                  break;
                }

                latestWindow = res;

                _logger2['default'].debug('Picking webview \'' + latestWindow + '\'');
                context$2$0.next = 17;
                return _regeneratorRuntime.awrap(this.setContext(latestWindow));

              case 17:
                context$2$0.next = 19;
                return _regeneratorRuntime.awrap(this.remote.cancelPageLoad());

              case 19:
                return context$2$0.abrupt('return');

              case 20:
                if (!(Date.now() - start >= 90000)) {
                  context$2$0.next = 22;
                  break;
                }

                throw new Error('Could not navigate to webview; there are none!');

              case 22:

                _logger2['default'].warn("Could not find any webviews yet, refreshing/retrying");

                if (!(this.isRealDevice() || !this.opts.safari)) {
                  context$2$0.next = 29;
                  break;
                }

                context$2$0.next = 26;
                return _regeneratorRuntime.awrap(_bluebird2['default'].delay(spinTime));

              case 26:
                context$2$0.next = 28;
                return _regeneratorRuntime.awrap(spinHandles());

              case 28:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 29:
                element = undefined;
                context$2$0.prev = 30;

                _logger2['default'].debug('Finding and tapping reload button');
                context$2$0.next = 34;
                return _regeneratorRuntime.awrap(this.findUIElementOrElements('accessibility id', 'ReloadButton', '', false));

              case 34:
                element = context$2$0.sent;
                context$2$0.next = 37;
                return _regeneratorRuntime.awrap(this.nativeTap(element.ELEMENT));

              case 37:
                context$2$0.next = 45;
                break;

              case 39:
                context$2$0.prev = 39;
                context$2$0.t1 = context$2$0['catch'](30);

                _logger2['default'].warn('Error finding and tapping reload button: ' + context$2$0.t1.message);
                _logger2['default'].warn('Retrying.');
                context$2$0.next = 45;
                return _regeneratorRuntime.awrap(_bluebird2['default'].delay(spinTime));

              case 45:
                context$2$0.next = 47;
                return _regeneratorRuntime.awrap(spinHandles());

              case 47:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 48:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this5, [[1, 7], [30, 39]]);
        };

        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(spinHandles());

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.closeAlertBeforeTest = function callee$0$0() {
  var present;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.alertIsPresent()'));

      case 2:
        present = context$1$0.sent;

        if (present) {
          context$1$0.next = 5;
          break;
        }

        return context$1$0.abrupt('return', false);

      case 5:

        _logger2['default'].debug('Alert present before starting test, let us banish it');
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.dismissAlert()'));

      case 8:
        _logger2['default'].debug('Alert banished!');
        return context$1$0.abrupt('return', true);

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.stopRemote = function callee$0$0() {
  var closeWindowBeforeDisconnecting = arguments.length <= 0 || arguments[0] === undefined ? false : arguments[0];
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.remote) {
          _logger2['default'].errorAndThrow('Tried to leave a web frame but were not in one');
        }

        if (!closeWindowBeforeDisconnecting) {
          context$1$0.next = 4;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.closeWindow());

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.remote.disconnect());

      case 6:
        this.curContext = null;
        this.curWebFrames = [];
        this.curWebCoords = null;
        this.remote = null;

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.isWebContext = function () {
  return !!this.curContext && this.curContext !== NATIVE_WIN;
};

helpers.setCurrentUrl = function (url) {
  this._currentUrl = url;
};

helpers.getCurrentUrl = function () {
  return this._currentUrl;
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports.NATIVE_WIN = NATIVE_WIN;
exports.WEBVIEW_WIN = WEBVIEW_WIN;
exports.WEBVIEW_BASE = WEBVIEW_BASE;
exports['default'] = extensions;

// already in the named context, no need to do anything

// switching into a webview context

// if contexts have not already been retrieved, get them

// `contextId` will be in the form of `appId.pageId` in this case

// real device, and already connected

// simulator, and already connected

// real device, and not connected

// it is reasonable to expect that this might be called when there is no
// webkit remote debugger to connect to

// generally this means that Safari is in page viewing mode
// so try to open a new page and then redo the navigation

// get the last address element and set the url

// this is flakey on certain systems so we retry until we get something
// ios sims: safari opens but the text field can't be found

// make it happen

// wait for page to finish loading.

// no webview was found

// too slow, get out

// on a real device, when not using Safari, we just want to try again

// find the reload button and tap it, if possible

// try it all again
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9jb250ZXh0LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7c0JBQWMsUUFBUTs7Ozt3QkFDUixVQUFVOzs7O3dCQUNNLFVBQVU7O29DQUNhLHdCQUF3Qjs7MENBQzNDLG1DQUFtQzs7Z0NBQzlDLG9CQUFvQjs7c0JBQ3hCLFdBQVc7Ozs7NkJBQ1QsZ0JBQWdCOztBQUdyQyxJQUFNLFVBQVUsR0FBRyxZQUFZLENBQUM7QUFDaEMsSUFBTSxXQUFXLEdBQUcsU0FBUyxDQUFDO0FBQzlCLElBQU0sWUFBWSxHQUFNLFdBQVcsTUFBRyxDQUFDOztBQUV2QyxJQUFJLFFBQVEsR0FBRyxFQUFFO0lBQUUsT0FBTyxHQUFHLEVBQUU7SUFBRSxVQUFVLEdBQUcsRUFBRSxDQUFDOztBQUVqRCxRQUFRLENBQUMsaUJBQWlCLEdBQUc7Ozs7Y0FDdkIsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsVUFBVSxLQUFLLFVBQVUsQ0FBQTs7Ozs7aURBQ3pDLFlBQVksR0FBRyxJQUFJLENBQUMsVUFBVTs7OzRDQUVqQyxVQUFVOzs7Ozs7O0NBRXBCLENBQUM7O0FBRUYsUUFBUSxDQUFDLFdBQVcsR0FBRztNQUVqQixRQUFROzs7O0FBRFosNEJBQU8sS0FBSyxDQUFDLG9DQUFvQyxDQUFDLENBQUM7O3lDQUM5QixJQUFJLENBQUMsbUJBQW1CLENBQUMsS0FBSyxDQUFDOzs7QUFBaEQsZ0JBQVE7NENBQ0wsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFDLE9BQU87aUJBQUssT0FBTyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUU7U0FBQSxDQUFDOzs7Ozs7O0NBQ3hELENBQUM7O0FBRUYsUUFBUSxDQUFDLFVBQVUsR0FBRyxvQkFBZ0IsSUFBSSxFQUFFLFFBQVEsRUFBRSxjQUFjO01BQ3pELGdCQUFnQixFQXVCbkIsU0FBUyxpQkFtQk4sUUFBUSxFQUFFLFNBQVM7Ozs7O0FBMUNuQix3QkFBZ0IsWUFBaEIsZ0JBQWdCLENBQUUs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QUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUU7OztBQUM5QixZQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztBQUN2QixZQUFJLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQztBQUN2QixZQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztBQUN6QixZQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQzs7Ozs7OztDQUNwQixDQUFDOztBQUVGLE9BQU8sQ0FBQyxZQUFZLEdBQUcsWUFBWTtBQUNqQyxTQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxVQUFVLEtBQUssVUFBVSxDQUFDO0NBQzVELENBQUM7O0FBRUYsT0FBTyxDQUFDLGFBQWEsR0FBRyxVQUFVLEdBQUcsRUFBRTtBQUNyQyxNQUFJLENBQUMsV0FBVyxHQUFHLEdBQUcsQ0FBQztDQUN4QixDQUFDOztBQUVGLE9BQU8sQ0FBQyxhQUFhLEdBQUcsWUFBWTtBQUNsQyxTQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7Q0FDekIsQ0FBQzs7QUFHRixlQUFjLFVBQVUsRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDcEMsUUFBUSxHQUFSLFFBQVE7UUFBRSxPQUFPLEdBQVAsT0FBTztRQUFFLFVBQVUsR0FBVixVQUFVO1FBQUUsV0FBVyxHQUFYLFdBQVc7UUFBRSxZQUFZLEdBQVosWUFBWTtxQkFDbEQsVUFBVSIsImZpbGUiOiJsaWIvY29tbWFuZHMvY29udGV4dC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgUmVtb3RlRGVidWdnZXIsIFdlYktpdFJlbW90ZURlYnVnZ2VyIH0gZnJvbSAnYXBwaXVtLXJlbW90ZS1kZWJ1Z2dlcic7XG5pbXBvcnQgeyBJT1NQZXJmb3JtYW5jZUxvZyB9IGZyb20gJy4uL2RldmljZS1sb2cvaW9zLXBlcmZvcm1hbmNlLWxvZyc7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcblxuXG5jb25zdCBOQVRJVkVfV0lOID0gJ05BVElWRV9BUFAnO1xuY29uc3QgV0VCVklFV19XSU4gPSAnV0VCVklFVyc7XG5jb25zdCBXRUJWSUVXX0JBU0UgPSBgJHtXRUJWSUVXX1dJTn1fYDtcblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb21tYW5kcy5nZXRDdXJyZW50Q29udGV4dCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgaWYgKHRoaXMuY3VyQ29udGV4dCAmJiB0aGlzLmN1ckNvbnRleHQgIT09IE5BVElWRV9XSU4pIHtcbiAgICByZXR1cm4gYCR7V0VCVklFV19CQVNFfSR7dGhpcy5jdXJDb250ZXh0fWA7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIE5BVElWRV9XSU47XG4gIH1cbn07XG5cbmNvbW1hbmRzLmdldENvbnRleHRzID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsb2dnZXIuZGVidWcoJ0dldHRpbmcgbGlzdCBvZiBhdmFpbGFibGUgY29udGV4dHMnKTtcbiAgbGV0IGNvbnRleHRzID0gYXdhaXQgdGhpcy5nZXRDb250ZXh0c0FuZFZpZXdzKGZhbHNlKTtcbiAgcmV0dXJuIGNvbnRleHRzLm1hcCgoY29udGV4dCkgPT4gY29udGV4dC5pZC50b1N0cmluZygpKTtcbn07XG5cbmNvbW1hbmRzLnNldENvbnRleHQgPSBhc3luYyBmdW5jdGlvbiAobmFtZSwgY2FsbGJhY2ssIHNraXBSZWFkeUNoZWNrKSB7XG4gIGZ1bmN0aW9uIGFscmVhZHlJbkNvbnRleHQgKGRlc2lyZWQsIGN1cnJlbnQpIHtcbiAgICByZXR1cm4gKGRlc2lyZWQgPT09IGN1cnJlbnQgfHxcbiAgICAgICAgICAgKGRlc2lyZWQgPT09IG51bGwgJiYgY3VycmVudCA9PT0gTkFUSVZFX1dJTikgfHxcbiAgICAgICAgICAgKGRlc2lyZWQgPT09IE5BVElWRV9XSU4gJiYgY3VycmVudCA9PT0gbnVsbCkpO1xuICB9XG5cbiAgbG9nZ2VyLmRlYnVnKGBBdHRlbXB0aW5nIHRvIHNldCBjb250ZXh0IHRvICcke25hbWV9J2ApO1xuICBpZiAoYWxyZWFkeUluQ29udGV4dChuYW1lLCB0aGlzLmN1ckNvbnRleHQpKSB7XG4gICAgLy8gYWxyZWFkeSBpbiB0aGUgbmFtZWQgY29udGV4dCwgbm8gbmVlZCB0byBkbyBhbnl0aGluZ1xuICB9IGVsc2UgaWYgKG5hbWUgPT09IE5BVElWRV9XSU4gfHwgbmFtZSA9PT0gbnVsbCkge1xuICAgIC8vIHN3aXRjaGluZyBpbnRvIHRoZSBuYXRpdmUgY29udGV4dFxuICAgIHRoaXMuY3VyQ29udGV4dCA9IG51bGw7XG4gICAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICAgIHRoaXMucmVtb3RlLmRpc2Nvbm5lY3QoKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgLy8gc3dpdGNoaW5nIGludG8gYSB3ZWJ2aWV3IGNvbnRleHRcblxuICAgIC8vIGlmIGNvbnRleHRzIGhhdmUgbm90IGFscmVhZHkgYmVlbiByZXRyaWV2ZWQsIGdldCB0aGVtXG4gICAgaWYgKF8uaXNVbmRlZmluZWQodGhpcy5jb250ZXh0cykpIHtcbiAgICAgIGF3YWl0IHRoaXMuZ2V0Q29udGV4dHMoKTtcbiAgICB9XG5cbiAgICBsZXQgY29udGV4dElkID0gbmFtZS5yZXBsYWNlKFdFQlZJRVdfQkFTRSwgJycpO1xuICAgIGlmIChjb250ZXh0SWQgPT09ICcnKSB7XG4gICAgICAvLyBhbGxvdyB1c2VyIHRvIHBhc3MgaW4gXCJXRUJWSUVXXCIgd2l0aG91dCBhbiBpbmRleFxuICAgICAgLy8gdGhlIHNlY29uZCBjb250ZXh0IHdpbGwgYmUgdGhlIGZpcnN0IHdlYnZpZXcgYXNcbiAgICAgIC8vIHRoZSBmaXJzdCBpcyBhbHdheXMgTkFUSVZFX0FQUFxuICAgICAgY29udGV4dElkID0gdGhpcy5jb250ZXh0c1sxXTtcbiAgICB9XG4gICAgaWYgKCFfLmluY2x1ZGVzKHRoaXMuY29udGV4dHMsIGNvbnRleHRJZCkpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoQ29udGV4dEVycm9yKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICAgIGlmICh0aGlzLnJlbW90ZSkge1xuICAgICAgICBhd2FpdCB0aGlzLnJlbW90ZS5kaXNjb25uZWN0KCk7XG4gICAgICB9XG4gICAgICB0aGlzLmN1ckNvbnRleHQgPSBjb250ZXh0SWQ7XG4gICAgICBhd2FpdCB0aGlzLnJlbW90ZS5jb25uZWN0KGNvbnRleHRJZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGBjb250ZXh0SWRgIHdpbGwgYmUgaW4gdGhlIGZvcm0gb2YgYGFwcElkLnBhZ2VJZGAgaW4gdGhpcyBjYXNlXG4gICAgICBsZXQgW2FwcElkS2V5LCBwYWdlSWRLZXldID0gXy5tYXAoY29udGV4dElkLnNwbGl0KCcuJyksIChpZCkgPT4gcGFyc2VJbnQoaWQsIDEwKSk7XG4gICAgICBhd2FpdCB0aGlzLnJlbW90ZS5zZWxlY3RQYWdlKGFwcElkS2V5LCBwYWdlSWRLZXksIHNraXBSZWFkeUNoZWNrKTtcbiAgICAgIHRoaXMuY3VyQ29udGV4dCA9IGNvbnRleHRJZDtcbiAgICB9XG4gIH1cblxuICAvLyBhdHRlbXB0IHRvIHN0YXJ0IHBlcmZvcm1hbmNlIGxvZ2dpbmcsIGlmIHJlcXVlc3RlZFxuICBpZiAodGhpcy5wZXJmTG9nRW5hYmxlZCAmJiB0aGlzLnJlbW90ZSkge1xuICAgIGxvZ2dlci5kZWJ1ZyhgU3RhcnRpbmcgcGVyZm9ybWFuY2UgbG9nIG9uICcke3RoaXMuY3VyQ29udGV4dH0nYCk7XG4gICAgdGhpcy5sb2dzLnBlcmZvcm1hbmNlID0gbmV3IElPU1BlcmZvcm1hbmNlTG9nKHRoaXMucmVtb3RlKTtcbiAgICB0aGlzLmxvZ3MucGVyZm9ybWFuY2Uuc3RhcnRDYXB0dXJlKCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmdldFdpbmRvd0hhbmRsZSA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cbiAgcmV0dXJuIHRoaXMuY3VyQ29udGV4dC50b1N0cmluZygpO1xufTtcblxuY29tbWFuZHMuZ2V0V2luZG93SGFuZGxlcyA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cblxuICBsZXQgcGFnZUFycmF5ID0gYXdhaXQgdGhpcy5saXN0V2ViRnJhbWVzKCk7XG4gIHRoaXMud2luZG93SGFuZGxlQ2FjaGUgPSBfLm1hcChwYWdlQXJyYXksIHRoaXMubWFzc2FnZVBhZ2UpO1xuICBsZXQgaWRBcnJheSA9IF8ubWFwKHRoaXMud2luZG93SGFuZGxlQ2FjaGUsICdpZCcpO1xuICAvLyBzaW5jZSB3ZSB1c2UgdGhpcy5jb250ZXh0cyB0byBtYW5hZ2Ugc2VsZWN0aW5nIGRlYnVnZ2VyIHBhZ2VzLCBtYWtlXG4gIC8vIHN1cmUgaXQgZ2V0cyBwb3B1bGF0ZWQgZXZlbiBpZiBzb21lb25lIGRpZCBub3QgdXNlIHRoZVxuICAvLyBnZXRDb250ZXh0cyBtZXRob2RcbiAgaWYgKCF0aGlzLmNvbnRleHRzKSB7XG4gICAgdGhpcy5jb250ZXh0cyA9IGlkQXJyYXk7XG4gIH1cbiAgcmV0dXJuIF8ubWFwKGlkQXJyYXksIChpZCkgPT4gaWQudG9TdHJpbmcoKSk7XG59O1xuXG5jb21tYW5kcy5zZXRXaW5kb3cgPSBhc3luYyBmdW5jdGlvbiAobmFtZSwgc2tpcFJlYWR5Q2hlY2spIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cblxuICBpZiAoIV8uaW5jbHVkZXMoXy5tYXAodGhpcy53aW5kb3dIYW5kbGVDYWNoZSwgJ2lkJyksIG5hbWUpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hXaW5kb3dFcnJvcigpO1xuICB9XG4gIGxldCBwYWdlSWRLZXkgPSBwYXJzZUludChuYW1lLCAxMCk7XG4gIGlmICghdGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIGF3YWl0IHRoaXMucmVtb3RlLnNlbGVjdFBhZ2UocGFnZUlkS2V5LCBza2lwUmVhZHlDaGVjayk7XG4gICAgdGhpcy5jdXJDb250ZXh0ID0gdGhpcy5jdXJXaW5kb3dIYW5kbGUgPSBuYW1lO1xuICB9IGVsc2Uge1xuICAgIGlmIChuYW1lID09PSB0aGlzLmN1cldpbmRvd0hhbmRsZSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBSZW1vdGUgZGVidWdnZXIgaXMgYWxyZWFkeSBjb25uZWN0ZWQgdG8gd2luZG93ICcke25hbWV9J2ApO1xuICAgIH0gZWxzZSBpZiAoIV8uaW5jbHVkZXMoXy5tYXAodGhpcy53aW5kb3dIYW5kbGVDYWNoZSwgJ2lkJyksIG5hbWUpKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaFdpbmRvd0Vycm9yKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IHRoaXMucmVtb3RlLmRpc2Nvbm5lY3QoKTtcbiAgICAgIHRoaXMuY3VyQ29udGV4dCA9IHRoaXMuY3VyV2luZG93SGFuZGxlID0gbmFtZTtcbiAgICAgIGF3YWl0IHRoaXMucmVtb3RlLmNvbm5lY3QobmFtZSk7XG4gICAgfVxuICB9XG59O1xuXG5oZWxwZXJzLndlYkNvbnRleHRJbmRleCA9IGZ1bmN0aW9uICgpIHtcbiAgcmV0dXJuIHRoaXMuY3VyQ29udGV4dC5yZXBsYWNlKFdFQlZJRVdfQkFTRSwgJycpIC0gMTtcbn07XG5cbmV4dGVuc2lvbnMuaW5pdEF1dG9XZWJ2aWV3ID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBpZiAodGhpcy5vcHRzLmF1dG9XZWJ2aWV3KSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdTZXR0aW5nIGF1dG8gd2VidmlldycpO1xuICAgIGF3YWl0IHRoaXMubmF2VG9Jbml0aWFsV2Vidmlldyh0aGlzKTtcbiAgfVxufTtcblxuZXh0ZW5zaW9ucy5nZXRDb250ZXh0c0FuZFZpZXdzID0gYXN5bmMgZnVuY3Rpb24gKHVzZVVybCA9IHRydWUpIHtcbiAgbG9nZ2VyLmRlYnVnKCdSZXRyaWV2aW5nIGNvbnRleHRzIGFuZCB2aWV3cycpO1xuICBsZXQgd2Vidmlld3MgPSBhd2FpdCB0aGlzLmxpc3RXZWJGcmFtZXModXNlVXJsKTtcbiAgbGV0IGN0eHMgPSBbe2lkOiBOQVRJVkVfV0lOfV07XG4gIHRoaXMuY29udGV4dHMgPSBbTkFUSVZFX1dJTl07XG4gIGZvciAobGV0IHZpZXcgb2Ygd2Vidmlld3MpIHtcbiAgICBjdHhzLnB1c2goe2lkOiBgJHtXRUJWSUVXX0JBU0V9JHt2aWV3LmlkfWAsIHZpZXd9KTtcbiAgICB0aGlzLmNvbnRleHRzLnB1c2godmlldy5pZC50b1N0cmluZygpKTtcbiAgfVxuICByZXR1cm4gY3R4cztcbn07XG5cbmV4dGVuc2lvbnMubGlzdFdlYkZyYW1lcyA9IGFzeW5jIGZ1bmN0aW9uICh1c2VVcmwgPSB0cnVlKSB7XG4gIGlmICghdGhpcy5vcHRzLmJ1bmRsZUlkKSB7XG4gICAgbG9nZ2VyLmVycm9yQW5kVGhyb3coJ0Nhbm5vdCBlbnRlciB3ZWIgZnJhbWUgd2l0aG91dCBhIGJ1bmRsZSBJRCcpO1xuICB9XG5cbiAgdXNlVXJsID0gdXNlVXJsICYmICEhdGhpcy5nZXRDdXJyZW50VXJsKCk7XG4gIC8qIGpzaGludCBpZ25vcmU6c3RhcnQgKi9cbiAgbG9nZ2VyLmRlYnVnKGBTZWxlY3RpbmcgYnkgdXJsOiAke3VzZVVybH0gJHt1c2VVcmwgPyBgKGV4cGVjdGVkIHVybDogJyR7dGhpcy5nZXRDdXJyZW50VXJsKCl9JylgIDogJyd9YCk7XG4gIC8qIGpzaGludCBpZ25vcmU6ZW5kICovXG5cbiAgbGV0IGN1cnJlbnRVcmwgPSB1c2VVcmwgPyB0aGlzLmdldEN1cnJlbnRVcmwoKSA6IHVuZGVmaW5lZDtcbiAgbGV0IHBhZ2VBcnJheTtcbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkgJiYgdGhpcy5yZW1vdGUgJiYgdGhpcy5vcHRzLmJ1bmRsZUlkKSB7XG4gICAgLy8gcmVhbCBkZXZpY2UsIGFuZCBhbHJlYWR5IGNvbm5lY3RlZFxuICAgIHBhZ2VBcnJheSA9IGF3YWl0IHRoaXMucmVtb3RlLnBhZ2VBcnJheUZyb21Kc29uKCk7XG4gIH0gZWxzZSBpZiAodGhpcy5yZW1vdGUgJiYgdGhpcy5yZW1vdGUuYXBwSWRLZXkpIHtcbiAgICAvLyBzaW11bGF0b3IsIGFuZCBhbHJlYWR5IGNvbm5lY3RlZFxuICAgIHBhZ2VBcnJheSA9IGF3YWl0IHRoaXMucmVtb3RlLnNlbGVjdEFwcChjdXJyZW50VXJsLCB0aGlzLm9wdHMud2Vidmlld0Nvbm5lY3RSZXRyaWVzKTtcbiAgfSBlbHNlIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgLy8gcmVhbCBkZXZpY2UsIGFuZCBub3QgY29ubmVjdGVkXG4gICAgdHJ5IHtcbiAgICAgIHRoaXMucmVtb3RlID0gbmV3IFdlYktpdFJlbW90ZURlYnVnZ2VyKHtwb3J0OiB0aGlzLm9wdHMud2Via2l0RGVidWdQcm94eVBvcnR9KTtcbiAgICAgIHBhZ2VBcnJheSA9IGF3YWl0IHRoaXMucmVtb3RlLnBhZ2VBcnJheUZyb21Kc29uKCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBpdCBpcyByZWFzb25hYmxlIHRvIGV4cGVjdCB0aGF0IHRoaXMgbWlnaHQgYmUgY2FsbGVkIHdoZW4gdGhlcmUgaXMgbm9cbiAgICAgIC8vIHdlYmtpdCByZW1vdGUgZGVidWdnZXIgdG8gY29ubmVjdCB0b1xuICAgICAgaWYgKCFfLmluY2x1ZGVzKGVyci5tZXNzYWdlLCAnY29ubmVjdCBFQ09OTlJFRlVTRUQnKSkgdGhyb3cgZXJyO1xuXG4gICAgICBsb2dnZXIud2FybignQXR0ZW1wdGVkIHRvIGdldCBhIGxpc3Qgb2Ygd2VidmlldyBjb250ZXh0cyBidXQgY291bGQgbm90IGNvbm5lY3QgdG8gJyArXG4gICAgICAgICAgICAgICAgICAnaW9zLXdlYmtpdC1kZWJ1Zy1wcm94eS4gSWYgeW91IGV4cGVjdCB0byBmaW5kIHdlYnZpZXdzLCBwbGVhc2UgZW5zdXJlICcgK1xuICAgICAgICAgICAgICAgICAgJ3RoYXQgdGhlIHByb3h5IGlzIHJ1bm5pbmcgYW5kIGFjY2Vzc2libGUnKTtcbiAgICAgIHRoaXMucmVtb3RlID0gbnVsbDtcbiAgICAgIHBhZ2VBcnJheSA9IFtdO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICAvLyBzaW11bGF0b3IsIGFuZCBub3QgY29ubmVjdGVkXG4gICAgdGhpcy5yZW1vdGUgPSBuZXcgUmVtb3RlRGVidWdnZXIoe1xuICAgICAgYnVuZGxlSWQ6IHRoaXMub3B0cy5idW5kbGVJZCxcbiAgICAgIHVzZU5ld1NhZmFyaTogdGhpcy51c2VOZXdTYWZhcmkoKSxcbiAgICAgIHBhZ2VMb2FkTXM6IHRoaXMucGFnZUxvYWRNcyxcbiAgICAgIHBsYXRmb3JtVmVyc2lvbjogdGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvblxuICAgIH0pO1xuXG4gICAgbGV0IGFwcEluZm8gPSBhd2FpdCB0aGlzLnJlbW90ZS5jb25uZWN0KCk7XG4gICAgaWYgKCFhcHBJbmZvKSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ1VuYWJsZSB0byBjb25uZWN0IHRvIHRoZSByZW1vdGUgZGVidWdnZXIuJyk7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIHBhZ2VBcnJheSA9IGF3YWl0IHRoaXMucmVtb3RlLnNlbGVjdEFwcChjdXJyZW50VXJsLCB0aGlzLm9wdHMud2Vidmlld0Nvbm5lY3RSZXRyaWVzKTtcbiAgICB0aGlzLnJlbW90ZS5vbihSZW1vdGVEZWJ1Z2dlci5FVkVOVF9QQUdFX0NIQU5HRSwgdGhpcy5vblBhZ2VDaGFuZ2UuYmluZCh0aGlzKSk7XG5cbiAgICBsZXQgdHJ5Q2xvc2luZ0FsZXJ0ID0gYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IGRpZERpc21pc3MgPSBhd2FpdCB0aGlzLmNsb3NlQWxlcnRCZWZvcmVUZXN0KCk7XG4gICAgICBpZiAoIWRpZERpc21pc3MpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDbG9zZSBhbGVydCBmYWlsZWQuIFJldHJ5LicpO1xuICAgICAgfVxuICAgIH07XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHJldHJ5SW50ZXJ2YWwoMywgNDAwMCwgdHJ5Q2xvc2luZ0FsZXJ0KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIGlmIHRoZSBsb29wIHRvIGNsb3NlIGFsZXJ0cyBmYWlsZWQgdG8gZGlzbWlzcywgaWdub3JlLFxuICAgICAgLy8gb3RoZXJ3aXNlIGxvZyBhbmQgdGhyb3cgdGhlIGVycm9yXG4gICAgICBpZiAoZXJyLm1lc3NhZ2UgIT09ICdDbG9zZSBhbGVydCBmYWlsZWQuIFJldHJ5LicpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3coZXJyKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBpZiAocGFnZUFycmF5Lmxlbmd0aCA9PT0gMCkge1xuICAgIC8vIHdlIGhhdmUgbm8gd2ViIGZyYW1lcywgYnV0IGNvbnRpbnVlIGFueXdheVxuICAgIGxvZ2dlci5kZWJ1ZygnTm8gd2ViIGZyYW1lcyBmb3VuZC4nKTtcbiAgfVxuICByZXR1cm4gcGFnZUFycmF5O1xufTtcblxuZXh0ZW5zaW9ucy5vblBhZ2VDaGFuZ2UgPSBhc3luYyBmdW5jdGlvbiAocGFnZUNoYW5nZU5vdGlmaWNhdGlvbikge1xuICBsb2dnZXIuZGVidWcoYFJlbW90ZSBkZWJ1Z2dlciBub3RpZmllZCB1cyBvZiBhIG5ldyBwYWdlIGxpc3Rpbmc6ICR7SlNPTi5zdHJpbmdpZnkocGFnZUNoYW5nZU5vdGlmaWNhdGlvbil9YCk7XG4gIGlmICh0aGlzLnNlbGVjdGluZ05ld1BhZ2UpIHtcbiAgICBsb2dnZXIuZGVidWcoJ1dlIGFyZSBpbiB0aGUgbWlkZGxlIG9mIHNlbGVjdGluZyBhIHBhZ2UsIGlnbm9yaW5nJyk7XG4gICAgcmV0dXJuO1xuICB9XG4gIGlmICghdGhpcy5yZW1vdGUuYXBwSWRLZXkpIHtcbiAgICBsb2dnZXIuZGVidWcoJ1dlIGhhdmUgbm90IHlldCBjb25uZWN0ZWQsIGlnbm9yaW5nJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbGV0IHthcHBJZEtleSwgcGFnZUFycmF5fSA9IHBhZ2VDaGFuZ2VOb3RpZmljYXRpb247XG5cbiAgbGV0IG5ld0lkcyA9IFtdO1xuICBsZXQgbmV3UGFnZXMgPSBbXTtcbiAgbGV0IGtleUlkID0gbnVsbDtcbiAgZm9yIChsZXQgcGFnZSBvZiBwYWdlQXJyYXkpIHtcbiAgICBsZXQgaWQgPSBwYWdlLmlkLnRvU3RyaW5nKCk7XG4gICAgbmV3SWRzLnB1c2goaWQpO1xuICAgIGlmIChwYWdlLmlzS2V5KSB7XG4gICAgICBrZXlJZCA9IGlkO1xuICAgIH1cbiAgICBsZXQgY29udGV4dElkID0gYCR7YXBwSWRLZXl9LiR7aWR9YDtcbiAgICBpZiAoIV8uaW5jbHVkZXModGhpcy5jb250ZXh0cywgY29udGV4dElkKSkge1xuICAgICAgbmV3UGFnZXMucHVzaChpZCk7XG4gICAgICB0aGlzLmNvbnRleHRzLnB1c2goY29udGV4dElkKTtcbiAgICB9XG4gIH1cblxuICBpZiAoIWtleUlkKSB7XG4gICAgLy8gaWYgdGhlcmUgaXMgbm8ga2V5IGlkLCBwdWxsIHRoZSBmaXJzdCBpZCBmcm9tIHRoZSBwYWdlIGFycmF5IGFuZCB1c2UgdGhhdFxuICAgIC8vIGFzIGEgc3RhbmQgaW5cbiAgICBsb2dnZXIuZGVidWcoJ05vIGtleSBpZCBmb3VuZC4gQ2hvb3NpbmcgZmlyc3QgaWQgZnJvbSBwYWdlIGFycmF5Jyk7XG4gICAga2V5SWQgPSBuZXdJZHNbMF0gfHwgbnVsbDtcbiAgfVxuXG4gIGxldCBuZXdQYWdlID0gbnVsbDtcbiAgaWYgKHRoaXMuY3VyQ29udGV4dCA9PT0gbnVsbCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnV2UgZG8gbm90IGFwcGVhciB0byBoYXZlIHdpbmRvdyBzZXQgeWV0LCBpZ25vcmluZycpO1xuICB9IGVsc2Uge1xuICAgIGxldCBbY3VyQXBwSWRLZXksIGN1clBhZ2VJZEtleV0gPSB0aGlzLmN1ckNvbnRleHQuc3BsaXQoJy4nKTtcblxuICAgIGlmIChjdXJBcHBJZEtleSAhPT0gYXBwSWRLZXkpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZygnUGFnZSBjaGFuZ2Ugbm90IHJlZmVycmluZyB0byBjdXJyZW50bHkgc2VsZWN0ZWQgYXBwLCBpZ25vcmluZy4nKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAobmV3UGFnZXMubGVuZ3RoKSB7XG4gICAgICBuZXdQYWdlID0gXy5sYXN0KG5ld1BhZ2VzKTtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgV2UgaGF2ZSBuZXcgcGFnZXMsIGdvaW5nIHRvIHNlbGVjdCBwYWdlICcke25ld1BhZ2V9J2ApO1xuICAgIH0gZWxzZSBpZiAoIV8uaW5jbHVkZXMobmV3SWRzLCBjdXJQYWdlSWRLZXkpKSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ05ldyBwYWdlIGxpc3RpbmcgZnJvbSByZW1vdGUgZGVidWdnZXIgZG9lcyBub3QgY29udGFpbiAnICtcbiAgICAgICAgICAgICAgICAgICAnY3VycmVudCB3aW5kb3c7IGFzc3VtaW5nIGl0IGlzIGNsb3NlZCcpO1xuICAgICAgaWYgKGtleUlkICE9PSBudWxsKSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgRGVidWdnZXIgYWxyZWFkeSBzZWxlY3RlZCBwYWdlICcke2tleUlkfScsIGAgK1xuICAgICAgICAgICAgICAgICAgICAgYGNvbmZpcm1pbmcgdGhhdCBjaG9pY2UuYCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ0RvIG5vdCBoYXZlIG91ciBjdXJyZW50IHdpbmRvdyBhbnltb3JlLCBhbmQgdGhlcmUgJyArXG4gICAgICAgICAgICAgICAgICAgICAnYXJlIG5vdCBhbnkgbW9yZSB0byBsb2FkISBEb2luZyBub3RoaW5nLi4uJyk7XG4gICAgICAgIHRoaXMuc2V0Q3VycmVudFVybCh1bmRlZmluZWQpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICB0aGlzLmN1ckNvbnRleHQgPSBgJHthcHBJZEtleX0uJHtrZXlJZH1gO1xuICAgICAgbmV3UGFnZSA9IGtleUlkO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ0NoZWNraW5nIGlmIHBhZ2UgbmVlZHMgdG8gbG9hZCcpO1xuICAgICAgLy8gSWYgYSB3aW5kb3cgbmF2aWdhdGVzIHRvIGFuIGFuY2hvciBpdCBkb2Vzbid0IGFsd2F5cyBmaXJlIGEgcGFnZVxuICAgICAgLy8gY2FsbGJhY2sgZXZlbnQuIExldCdzIGNoZWNrIGlmIHdlIHdvdW5kIHVwIGluIHN1Y2ggYSBzaXR1YXRpb24uXG4gICAgICBsZXQgbmVlZHNQYWdlTG9hZCA9ICgoKSA9PiB7XG4gICAgICAgIGxldCBpdGVtID0gKGFycikgPT4ge1xuICAgICAgICAgIHJldHVybiBfLmZpbHRlcihhcnIsIChvYmopID0+IHtcbiAgICAgICAgICAgIHJldHVybiBvYmouaWQgPT09IHRoaXMuY3VyQ29udGV4dDtcbiAgICAgICAgICB9KVswXTtcbiAgICAgICAgfTtcblxuICAgICAgICAvLyBuZWVkIHRvIG1hcCB0aGUgcGFnZSBpZHMgdG8gY29udGV4dCBpZHNcbiAgICAgICAgbGV0IGNvbnRleHRBcnJheSA9IF8ubWFwKHBhZ2VBcnJheSwgKGFycikgPT4ge1xuICAgICAgICAgIHJldHVybiB7aWQ6IGAke2FwcElkS2V5fS4ke2Fyci5pZH1gfTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiAhXy5pc0VxdWFsKGl0ZW0odGhpcy5jb250ZXh0cyksIGl0ZW0oY29udGV4dEFycmF5KSk7XG4gICAgICB9KSgpO1xuXG4gICAgICBpZiAobmVlZHNQYWdlTG9hZCkge1xuICAgICAgICBsb2dnZXIuZGVidWcoJ1BhZ2UgbG9hZCBuZWVkZWQuIExvYWRpbmcuJyk7XG4gICAgICAgIGF3YWl0IHRoaXMucmVtb3RlLnBhZ2VMb2FkKCk7XG4gICAgICB9XG5cbiAgICAgIGxvZ2dlci5kZWJ1ZygnTmV3IHBhZ2UgbGlzdGluZyBpcyBzYW1lIGFzIG9sZCwgZG9pbmcgbm90aGluZycpO1xuICAgIH1cbiAgfVxuXG4gIC8vIG1ha2Ugc3VyZSB0aGF0IHRoZSBwYWdlIGxpc3RpbmcgaXNuJ3QgaW5kaWNhdGluZyBhIHJlZGlyZWN0XG4gIGlmICh1dGlsLmhhc1ZhbHVlKHRoaXMuY3VyQ29udGV4dCkpIHtcbiAgICBsZXQgY3VycmVudFBhZ2VJZCA9IHBhcnNlSW50KF8ubGFzdCh0aGlzLmN1ckNvbnRleHQuc3BsaXQoJy4nKSksIDEwKTtcbiAgICBsZXQgcGFnZSA9IF8uZmluZChwYWdlQXJyYXksIChwKSA9PiBwYXJzZUludChwLmlkLCAxMCkgPT09IGN1cnJlbnRQYWdlSWQpO1xuICAgIGlmIChwYWdlICYmIHBhZ2UudXJsICE9PSB0aGlzLmdldEN1cnJlbnRVcmwoKSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBSZWRpcmVjdGVkIGZyb20gJyR7dGhpcy5nZXRDdXJyZW50VXJsKCl9JyB0byAnJHtwYWdlLnVybH0nYCk7XG4gICAgICB0aGlzLnNldEN1cnJlbnRVcmwocGFnZS51cmwpO1xuICAgIH1cbiAgfVxuXG4gIGlmICh1dGlsLmhhc1ZhbHVlKG5ld1BhZ2UpKSB7XG4gICAgdGhpcy5zZWxlY3RpbmdOZXdQYWdlID0gdHJ1ZTtcbiAgICBhd2FpdCB0aGlzLnJlbW90ZS5zZWxlY3RQYWdlKGFwcElkS2V5LCBwYXJzZUludChuZXdQYWdlLCAxMCkpO1xuICAgIHRoaXMuc2VsZWN0aW5nTmV3UGFnZSA9IGZhbHNlO1xuICAgIHRoaXMuY3VyQ29udGV4dCA9IGAke2FwcElkS2V5fS4ke25ld1BhZ2V9YDtcbiAgfVxuICB0aGlzLndpbmRvd0hhbmRsZUNhY2hlID0gXy5tYXAocGFnZUFycmF5LCB0aGlzLm1hc3NhZ2VQYWdlKTtcbn07XG5cbmV4dGVuc2lvbnMuZ2V0TGF0ZXN0V2Vidmlld0NvbnRleHRGb3JUaXRsZSA9IGFzeW5jIGZ1bmN0aW9uIChyZWdFeHApIHtcbiAgbGV0IGNvbnRleHRzID0gYXdhaXQgdGhpcy5nZXRDb250ZXh0c0FuZFZpZXdzKCk7XG4gIGxldCBtYXRjaGluZ0N0eDtcbiAgZm9yIChsZXQgY3R4IG9mIGNvbnRleHRzKSB7XG4gICAgaWYgKGN0eC52aWV3ICYmICgoY3R4LnZpZXcudGl0bGUgfHwgJycpLm1hdGNoKHJlZ0V4cCkgfHwgKGN0eC52aWV3LnVybCB8fCAnJykubWF0Y2gocmVnRXhwKSkpIHtcbiAgICAgIGlmIChjdHgudmlldy51cmwgIT09ICdhYm91dDpibGFuaycpIHtcbiAgICAgICAgbWF0Y2hpbmdDdHggPSBjdHg7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBpbiB0aGUgY2FzZXMgb2YgWGNvZGUgPCA1IChpLmUuLCBpT1MgU0RLIFZlcnNpb24gbGVzcyB0aGFuIDcpXG4gICAgICAgIC8vIGlPUyA3LjEsIGlPUyA5LjAgJiBpT1MgOS4xIGluIGEgd2VidmlldyAobm90IGluIFNhZmFyaSlcbiAgICAgICAgLy8gd2UgY2FuIGhhdmUgdGhlIHVybCBiZSBgYWJvdXQ6YmxhbmtgXG4gICAgICAgIGlmIChwYXJzZUZsb2F0KHRoaXMuaW9zU2RrVmVyc2lvbikgPCA3IHx8IHBhcnNlRmxvYXQodGhpcy5pb3NTZGtWZXJzaW9uKSA+PSA5IHx8XG4gICAgICAgICAgICAodGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbiA9PT0gJzcuMScgJiYgdGhpcy5vcHRzLmFwcCAmJiB0aGlzLm9wdHMuYXBwLnRvTG93ZXJDYXNlKCkgIT09ICdzYWZhcmknKSkge1xuICAgICAgICAgIG1hdGNoaW5nQ3R4ID0gY3R4O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG1hdGNoaW5nQ3R4ID8gbWF0Y2hpbmdDdHguaWQgOiB1bmRlZmluZWQ7XG59O1xuXG4vLyBSaWdodCBub3cgd2UgZG9uJ3QgbmVjZXNzYXJpbHkgd2FpdCBmb3Igd2Vidmlld1xuLy8gYW5kIGZyYW1lIHRvIGxvYWQsIHdoaWNoIGxlYWRzIHRvIHJhY2UgY29uZGl0aW9ucyBhbmQgZmxha2luZXNzLFxuLy8gbGV0J3Mgc2VlIGlmIHdlIGNhbiB0cmFuc2l0aW9uIHRvIHNvbWV0aGluZyBiZXR0ZXJcbmV4dGVuc2lvbnMudXNlTmV3U2FmYXJpID0gZnVuY3Rpb24gKCkge1xuICByZXR1cm4gcGFyc2VGbG9hdCh0aGlzLmlvc1Nka1ZlcnNpb24pID49IDguMSAmJlxuICAgICAgICAgcGFyc2VGbG9hdCh0aGlzLm9wdHMucGxhdGZvcm1WZXJzaW9uKSA+PSA4LjEgJiZcbiAgICAgICAgICF0aGlzLmlzUmVhbERldmljZSgpICYmXG4gICAgICAgICB0aGlzLm9wdHMuc2FmYXJpO1xufTtcblxuZXh0ZW5zaW9ucy5uYXZUb0luaXRpYWxXZWJ2aWV3ID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsZXQgdGltZW91dCA9IDA7XG4gIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgdGltZW91dCA9IDMwMDA7XG4gICAgbG9nZ2VyLmRlYnVnKGBXYWl0aW5nIGZvciAke3RpbWVvdXR9IG1zIGJlZm9yZSBuYXZpZ2F0aW5nIHRvIHZpZXcuYCk7XG4gIH1cbiAgYXdhaXQgQi5kZWxheSh0aW1lb3V0KTtcbiAgaWYgKHRoaXMudXNlTmV3U2FmYXJpKCkpIHtcbiAgICBhd2FpdCB0aGlzLnR5cGVBbmROYXZUb1VybCgpO1xuICB9IGVsc2UgaWYgKHBhcnNlSW50KHRoaXMuaW9zU2RrVmVyc2lvbiwgMTApID49IDcgJiYgIXRoaXMuaXNSZWFsRGV2aWNlKCkgJiYgdGhpcy5vcHRzLnNhZmFyaSkge1xuICAgIGF3YWl0IHRoaXMubmF2VG9WaWV3VGhyb3VnaEZhdm9yaXRlcygpO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IHRoaXMubmF2VG9WaWV3V2l0aFRpdGxlKC8uKi8pO1xuICB9XG59O1xuXG5hc3luYyBmdW5jdGlvbiBvcGVuTmV3UGFnZSAoKSB7XG4gIGxldCBuZXdQYWdlQnV0dG9uID0gYXdhaXQgdGhpcy5maW5kRWxlbWVudCgneHBhdGgnLCBcIi8vVUlBQnV0dG9uW2NvbnRhaW5zKEBuYW1lLCdOZXcgcGFnZScpXVwiKTtcbiAgYXdhaXQgdGhpcy5uYXRpdmVUYXAobmV3UGFnZUJ1dHRvbi5FTEVNRU5UKTtcbn1cblxuZXh0ZW5zaW9ucy50eXBlQW5kTmF2VG9VcmwgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxldCBhZGRyZXNzID0gdGhpcy5vcHRzLmFkZHJlc3MgPyB0aGlzLm9wdHMuYWRkcmVzcyA6ICcxMjcuMC4wLjEnO1xuICB0aGlzLnNldEN1cnJlbnRVcmwodGhpcy5jYXBzLnNhZmFyaUluaXRpYWxVcmwgfHwgYGh0dHA6Ly8ke2FkZHJlc3N9OiR7dGhpcy5vcHRzLnBvcnR9L3dlbGNvbWVgKTtcblxuICBsZXQgdHJpZXMgPSAwO1xuICBjb25zdCBNQVhfVFJJRVMgPSAyO1xuICBsZXQgbmF2aWdhdGUgPSBhc3luYyAoKSA9PiB7XG4gICAgbGV0IG9sZEltcFdhaXQgPSB0aGlzLmltcGxpY2l0V2FpdE1zO1xuICAgIHRoaXMuaW1wbGljaXRXYWl0TXMgPSA3MDAwO1xuXG4gICAgLy8gZmluZCB0aGUgdXJsIGJhciwgYW5kIHRhcCBvbiBpdC4gcmV0cnkgdG8gbWFrZSBzdXJlIHdlIGRvbid0IHRyeVxuICAgIC8vIHRvbyBzb29uIHdoaWxlIHRoZSB2aWV3IGlzIHN0aWxsIGxvYWRpbmdcbiAgICBsZXQgZWwgPSBhd2FpdCByZXRyeUludGVydmFsKDMsIDEwMDAsIGFzeW5jICgpID0+IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRFbGVtZW50KCdhY2Nlc3NpYmlsaXR5IGlkJywgJ1VSTCcpO1xuICAgIH0pO1xuICAgIHRoaXMuaW1wbGljaXRXYWl0TXMgPSBvbGRJbXBXYWl0O1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMubmF0aXZlVGFwKGVsLkVMRU1FTlQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKF8uaW5jbHVkZXMoZXJyLm1lc3NhZ2UsICdjb3VsZCBub3QgYmUgdGFwcGVkJykpIHtcbiAgICAgICAgaWYgKHRyaWVzKysgPj0gTUFYX1RSSUVTKSB0aHJvdyBlcnI7XG5cbiAgICAgICAgLy8gZ2VuZXJhbGx5IHRoaXMgbWVhbnMgdGhhdCBTYWZhcmkgaXMgaW4gcGFnZSB2aWV3aW5nIG1vZGVcbiAgICAgICAgLy8gc28gdHJ5IHRvIG9wZW4gYSBuZXcgcGFnZSBhbmQgdGhlbiByZWRvIHRoZSBuYXZpZ2F0aW9uXG4gICAgICAgIGF3YWl0IG9wZW5OZXdQYWdlKCk7XG4gICAgICAgIHJldHVybiBhd2FpdCBuYXZpZ2F0ZSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGdldCB0aGUgbGFzdCBhZGRyZXNzIGVsZW1lbnQgYW5kIHNldCB0aGUgdXJsXG4gICAgdHJ5IHtcbiAgICAgIGxldCBlbCA9IGF3YWl0IHRoaXMuZmluZEVsZW1lbnQoJ2NsYXNzIG5hbWUnLCAnVUlBVGV4dEZpZWxkJyk7XG4gICAgICBhd2FpdCB0aGlzLnNldFZhbHVlSW1tZWRpYXRlKHRoaXMuZ2V0Q3VycmVudFVybCgpLCBlbCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyB0aGlzIGlzIGZsYWtleSBvbiBjZXJ0YWluIHN5c3RlbXMgc28gd2UgcmV0cnkgdW50aWwgd2UgZ2V0IHNvbWV0aGluZ1xuICAgICAgLy8gaW9zIHNpbXM6IHNhZmFyaSBvcGVucyBidXQgdGhlIHRleHQgZmllbGQgY2FuJ3QgYmUgZm91bmRcbiAgICAgIGlmICh0cmllcysrID49IE1BWF9UUklFUykgdGhyb3cgZXJyO1xuICAgICAgcmV0dXJuIGF3YWl0IG5hdmlnYXRlKCk7XG4gICAgfVxuXG4gICAgLy8gbWFrZSBpdCBoYXBwZW5cbiAgICB0cnkge1xuICAgICAgZWwgPSBhd2FpdCB0aGlzLmZpbmRFbGVtZW50KCdhY2Nlc3NpYmlsaXR5IGlkJywgJ0dvJyk7XG4gICAgICBhd2FpdCB0aGlzLm5hdGl2ZVRhcChlbC5FTEVNRU5UKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmIChfLmluY2x1ZGVzKGVyci5tZXNzYWdlLCAnY291bGQgbm90IGJlIHRhcHBlZCcpKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcignVW5hYmxlIHRvIHN1Ym1pdCBVUkwgYmVjYXVzZSBcXCdHb1xcJyBidXR0b24gY291bGQgbm90IGJlIHRhcHBlZC4gJyArXG4gICAgICAgICAgICAgICAgICAgICAnUGxlYXNlIG1ha2Ugc3VyZSB5b3VyIGtleWJvYXJkIGlzIHRvZ2dsZWQgb24uJyk7XG4gICAgICB9XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICAgIGF3YWl0IHRoaXMubmF2VG9WaWV3V2l0aFRpdGxlKHVuZGVmaW5lZCwgbmV3IFJlZ0V4cCh0aGlzLmdldEN1cnJlbnRVcmwoKSwgJ2knKSk7XG5cbiAgICAvLyB3YWl0IGZvciBwYWdlIHRvIGZpbmlzaCBsb2FkaW5nLlxuICAgIGF3YWl0IHRoaXMucmVtb3RlLnBhZ2VVbmxvYWQoKTtcbiAgfTtcbiAgYXdhaXQgbmF2aWdhdGUoKTtcbn07XG5cbmV4dGVuc2lvbnMubmF2VG9WaWV3VGhyb3VnaEZhdm9yaXRlcyA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbG9nZ2VyLmRlYnVnKCdXZSBhcmUgb24gaU9TNysgc2ltdWxhdG9yOiBjbGlja2luZyBhcHBsZSBidXR0b24gdG8gZ2V0IGludG8gYSB3ZWJ2aWV3Jyk7XG4gIGxldCBvbGRJbXBXYWl0ID0gdGhpcy5pbXBsaWNpdFdhaXRNcztcbiAgdGhpcy5pbXBsaWNpdFdhaXRNcyA9IDcwMDA7IC8vIHdhaXQgN3MgZm9yIGFwcGxlIGJ1dHRvbiB0byBleGlzdFxuXG4gIGxldCBlbDtcbiAgdHJ5IHtcbiAgICBlbCA9IGF3YWl0IHRoaXMuZmluZEVsZW1lbnQoJ3hwYXRoJywgJy8vVUlBU2Nyb2xsVmlld1sxXS9VSUFCdXR0b25bMV0nKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbGV0IG1zZyA9ICdDb3VsZCBub3QgZmluZCBidXR0b24gdG8gY2xpY2sgdG8gZ2V0IGludG8gd2Vidmlldy4gJyArXG4gICAgICAgICAgICAgICdQcm9jZWVkaW5nIG9uIHRoZSBhc3N1bXB0aW9uIHdlIGhhdmUgYSB3b3JraW5nIG9uZS4nO1xuICAgIGxvZ2dlci5lcnJvcihtc2cpO1xuICAgIHRoaXMuaW1wbGljaXRXYWl0TXMgPSBvbGRJbXBXYWl0O1xuICAgIHJldHVybiBhd2FpdCB0aGlzLm5hdlRvVmlld1dpdGhUaXRsZSgvLiovaSk7XG4gIH1cbiAgdGhpcy5pbXBsaWNpdFdhaXRNcyA9IG9sZEltcFdhaXQ7XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5uYXRpdmVUYXAoZWwuRUxFTUVOVCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxldCBtc2cgPSAnQ291bGQgbm90IGNsaWNrIGJ1dHRvbiB0byBnZXQgaW50byB3ZWJ2aWV3LiAnICtcbiAgICAgICAgICAgICAgJ1Byb2NlZWRpbmcgb24gdGhlIGFzc3VtcHRpb24gd2UgaGF2ZSBhIHdvcmtpbmcgb25lLic7XG4gICAgbG9nZ2VyLmVycm9yKG1zZyk7XG4gIH1cbiAgYXdhaXQgdGhpcy5uYXZUb1ZpZXdXaXRoVGl0bGUoL2FwcGxlL2kpO1xufTtcblxuZXh0ZW5zaW9ucy5uYXZUb1ZpZXdXaXRoVGl0bGUgPSBhc3luYyBmdW5jdGlvbiAodGl0bGVSZWdleCwgdXJsUmVnRXhwKSB7XG4gIGxvZ2dlci5kZWJ1ZygnTmF2aWdhdGluZyB0byBtb3N0IHJlY2VudGx5IG9wZW5lZCB3ZWJ2aWV3Jyk7XG4gIGxldCBzdGFydCA9IERhdGUubm93KCk7XG4gIGxldCBzcGluVGltZSA9IDUwMDtcbiAgbGV0IHNwaW5IYW5kbGVzID0gYXN5bmMgKCkgPT4ge1xuICAgIGxldCByZXM7XG4gICAgdHJ5IHtcbiAgICAgIHJlcyA9IGF3YWl0IHRoaXMuZ2V0TGF0ZXN0V2Vidmlld0NvbnRleHRGb3JUaXRsZSh0aXRsZVJlZ2V4IHx8IHVybFJlZ0V4cCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoZXJyLm1lc3NhZ2UuaW5kZXhPZignQ291bGQgbm90IGNvbm5lY3QgdG8gYSB2YWxpZCBhcHAgYWZ0ZXInKSA9PT0gLTEpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgbmF2aWdhdGUgdG8gd2VidmlldyEgRXJyOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgICAgbG9nZ2VyLmRlYnVnKCdDb3VsZCBub3QgbmF2aWdhdGUgdG8gd2Vidmlldy4gUmV0cnlpbmcgaWYgcG9zc2libGUuJyk7XG4gICAgfVxuICAgIGlmIChyZXMpIHtcbiAgICAgIGxldCBsYXRlc3RXaW5kb3cgPSByZXM7XG4gICAgICBsb2dnZXIuZGVidWcoYFBpY2tpbmcgd2VidmlldyAnJHtsYXRlc3RXaW5kb3d9J2ApO1xuICAgICAgYXdhaXQgdGhpcy5zZXRDb250ZXh0KGxhdGVzdFdpbmRvdyk7XG4gICAgICBhd2FpdCB0aGlzLnJlbW90ZS5jYW5jZWxQYWdlTG9hZCgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIG5vIHdlYnZpZXcgd2FzIGZvdW5kXG4gICAgaWYgKChEYXRlLm5vdygpIC0gc3RhcnQpID49IDkwMDAwKSB7XG4gICAgICAvLyB0b28gc2xvdywgZ2V0IG91dFxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgbmF2aWdhdGUgdG8gd2VidmlldzsgdGhlcmUgYXJlIG5vbmUhJyk7XG4gICAgfVxuXG4gICAgbG9nZ2VyLndhcm4oXCJDb3VsZCBub3QgZmluZCBhbnkgd2Vidmlld3MgeWV0LCByZWZyZXNoaW5nL3JldHJ5aW5nXCIpO1xuICAgIGlmICh0aGlzLmlzUmVhbERldmljZSgpIHx8ICF0aGlzLm9wdHMuc2FmYXJpKSB7XG4gICAgICAvLyBvbiBhIHJlYWwgZGV2aWNlLCB3aGVuIG5vdCB1c2luZyBTYWZhcmksIHdlIGp1c3Qgd2FudCB0byB0cnkgYWdhaW5cbiAgICAgIGF3YWl0IEIuZGVsYXkoc3BpblRpbWUpO1xuICAgICAgcmV0dXJuIGF3YWl0IHNwaW5IYW5kbGVzKCk7XG4gICAgfVxuXG4gICAgLy8gZmluZCB0aGUgcmVsb2FkIGJ1dHRvbiBhbmQgdGFwIGl0LCBpZiBwb3NzaWJsZVxuICAgIGxldCBlbGVtZW50O1xuICAgIHRyeSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ0ZpbmRpbmcgYW5kIHRhcHBpbmcgcmVsb2FkIGJ1dHRvbicpO1xuICAgICAgZWxlbWVudCA9IGF3YWl0IHRoaXMuZmluZFVJRWxlbWVudE9yRWxlbWVudHMoJ2FjY2Vzc2liaWxpdHkgaWQnLCAnUmVsb2FkQnV0dG9uJywgJycsIGZhbHNlKTtcbiAgICAgIGF3YWl0IHRoaXMubmF0aXZlVGFwKGVsZW1lbnQuRUxFTUVOVCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIud2FybihgRXJyb3IgZmluZGluZyBhbmQgdGFwcGluZyByZWxvYWQgYnV0dG9uOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgbG9nZ2VyLndhcm4oJ1JldHJ5aW5nLicpO1xuICAgICAgYXdhaXQgQi5kZWxheShzcGluVGltZSk7XG4gICAgfVxuXG4gICAgLy8gdHJ5IGl0IGFsbCBhZ2FpblxuICAgIHJldHVybiBhd2FpdCBzcGluSGFuZGxlcygpO1xuICB9O1xuICBhd2FpdCBzcGluSGFuZGxlcygpO1xufTtcblxuaGVscGVycy5jbG9zZUFsZXJ0QmVmb3JlVGVzdCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbGV0IHByZXNlbnQgPSBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZCgnYXUuYWxlcnRJc1ByZXNlbnQoKScpO1xuICBpZiAoIXByZXNlbnQpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBsb2dnZXIuZGVidWcoJ0FsZXJ0IHByZXNlbnQgYmVmb3JlIHN0YXJ0aW5nIHRlc3QsIGxldCB1cyBiYW5pc2ggaXQnKTtcbiAgYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoJ2F1LmRpc21pc3NBbGVydCgpJyk7XG4gIGxvZ2dlci5kZWJ1ZygnQWxlcnQgYmFuaXNoZWQhJyk7XG4gIHJldHVybiB0cnVlO1xufTtcblxuaGVscGVycy5zdG9wUmVtb3RlID0gYXN5bmMgZnVuY3Rpb24gKGNsb3NlV2luZG93QmVmb3JlRGlzY29ubmVjdGluZyA9IGZhbHNlKSB7XG4gIGlmICghdGhpcy5yZW1vdGUpIHtcbiAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdygnVHJpZWQgdG8gbGVhdmUgYSB3ZWIgZnJhbWUgYnV0IHdlcmUgbm90IGluIG9uZScpO1xuICB9XG5cbiAgaWYgKGNsb3NlV2luZG93QmVmb3JlRGlzY29ubmVjdGluZykge1xuICAgIGF3YWl0IHRoaXMuY2xvc2VXaW5kb3coKTtcbiAgfVxuICBhd2FpdCB0aGlzLnJlbW90ZS5kaXNjb25uZWN0KCk7XG4gIHRoaXMuY3VyQ29udGV4dCA9IG51bGw7XG4gIHRoaXMuY3VyV2ViRnJhbWVzID0gW107XG4gIHRoaXMuY3VyV2ViQ29vcmRzID0gbnVsbDtcbiAgdGhpcy5yZW1vdGUgPSBudWxsO1xufTtcblxuaGVscGVycy5pc1dlYkNvbnRleHQgPSBmdW5jdGlvbiAoKSB7XG4gIHJldHVybiAhIXRoaXMuY3VyQ29udGV4dCAmJiB0aGlzLmN1ckNvbnRleHQgIT09IE5BVElWRV9XSU47XG59O1xuXG5oZWxwZXJzLnNldEN1cnJlbnRVcmwgPSBmdW5jdGlvbiAodXJsKSB7XG4gIHRoaXMuX2N1cnJlbnRVcmwgPSB1cmw7XG59O1xuXG5oZWxwZXJzLmdldEN1cnJlbnRVcmwgPSBmdW5jdGlvbiAoKSB7XG4gIHJldHVybiB0aGlzLl9jdXJyZW50VXJsO1xufTtcblxuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzLCBOQVRJVkVfV0lOLCBXRUJWSUVXX1dJTiwgV0VCVklFV19CQVNFIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
