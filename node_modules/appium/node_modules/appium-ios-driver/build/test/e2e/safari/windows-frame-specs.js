"use strict";

var _regeneratorRuntime = require("babel-runtime/regenerator")["default"];

var _interopRequireDefault = require("babel-runtime/helpers/interop-require-default")["default"];

var _setupBase = require("../setup-base");

var _setupBase2 = _interopRequireDefault(_setupBase);

var _helpersEnv = require('../helpers/env');

var _helpersEnv2 = _interopRequireDefault(_helpersEnv);

var _helpersWebview = require("../helpers/webview");

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _helpersSession = require('../helpers/session');

describe("safari - windows and frames (" + _helpersEnv2["default"].DEVICE + ")", function () {
  this.timeout(_helpersSession.MOCHA_SAFARI_TIMEOUT);

  var driver = (0, _setupBase2["default"])(this, {
    browserName: 'safari',
    nativeWebTap: true,
    safariAllowPopups: true
  }).driver;

  describe('within webview', function () {
    var _this = this;

    before(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.implicitWait(1000));

          case 2:
          case "end":
            return context$3$0.stop();
        }
      }, null, _this);
    });
    beforeEach(function () {
      return (0, _helpersWebview.loadWebView)("safari", driver);
    });

    it("should throw nosuchwindow if there's not one", function () {
      return driver.setWindow('noexistman').should.be.rejectedWith(/window could not be found/);
    });

    // unfortunately, iOS8 doesn't respond to the close() method on window
    // the way iOS7 does
    it("should be able to open and close windows @skip-ios8", function callee$2$0() {
      var el;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.findElement('id', 'blanklink'));

          case 2:
            el = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(driver.click(el));

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap((0, _helpersWebview.spinTitle)("I am another page title", driver));

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(_bluebird2["default"].delay(2000));

          case 9:
            context$3$0.next = 11;
            return _regeneratorRuntime.awrap(driver.closeWindow());

          case 11:
            context$3$0.next = 13;
            return _regeneratorRuntime.awrap(_bluebird2["default"].delay(3000));

          case 13:
            context$3$0.next = 15;
            return _regeneratorRuntime.awrap((0, _helpersWebview.spinTitle)("I am a page title", driver));

          case 15:
          case "end":
            return context$3$0.stop();
        }
      }, null, _this);
    });

    it('should be able to go back and forward', function callee$2$0() {
      var link;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.findElement('link text', 'i am a link'));

          case 2:
            link = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(driver.click(link));

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(driver.findElement('id', 'only_on_page_2'));

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(driver.back());

          case 9:
            context$3$0.next = 11;
            return _regeneratorRuntime.awrap(driver.findElement('id', 'i_am_a_textbox'));

          case 11:
            context$3$0.next = 13;
            return _regeneratorRuntime.awrap(driver.forward());

          case 13:
            context$3$0.next = 15;
            return _regeneratorRuntime.awrap(driver.findElement('id', 'only_on_page_2'));

          case 15:
          case "end":
            return context$3$0.stop();
        }
      }, null, _this);
    });

    // broken on real devices, see https://github.com/appium/appium/issues/5167
    it("should be able to open js popup windows with safariAllowPopups set to true @skip-real-device", function callee$2$0() {
      var link;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.findElement('link text', 'i am a new window link'));

          case 2:
            link = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(driver.click(link));

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap((0, _helpersWebview.spinTitle)("I am another page title", driver, 30));

          case 7:
          case "end":
            return context$3$0.stop();
        }
      }, null, _this);
    });
  });
});

describe("safari - windows and frames (" + _helpersEnv2["default"].DEVICE + ") - without safariAllowPopups", function () {
  var _this2 = this;

  this.timeout(_helpersSession.MOCHA_SAFARI_TIMEOUT);

  var driver = (0, _setupBase2["default"])(this, {
    browserName: 'safari',
    safariAllowPopups: false
  }).driver;

  before(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(driver.implicitWait(5000));

        case 2:
        case "end":
          return context$2$0.stop();
      }
    }, null, _this2);
  });
  beforeEach(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _helpersWebview.loadWebView)("safari", driver));

        case 2:
          return context$2$0.abrupt("return", context$2$0.sent);

        case 3:
        case "end":
          return context$2$0.stop();
      }
    }, null, _this2);
  });

  it("should not be able to open js popup windows", function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(driver.execute("window.open('/test/guinea-pig2.html', null)"));

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap((0, _helpersWebview.spinTitle)("I am another page title", driver, 5).should.eventually.be.rejected);

        case 4:
        case "end":
          return context$2$0.stop();
      }
    }, null, _this2);
  });
});

// minimize waiting if something goes wrong

// minimize waiting if something goes wrong
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvZTJlL3NhZmFyaS93aW5kb3dzLWZyYW1lLXNwZWNzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozt5QkFBa0IsZUFBZTs7OzswQkFDakIsZ0JBQWdCOzs7OzhCQUNPLG9CQUFvQjs7d0JBQzdDLFVBQVU7Ozs7OEJBQ2Esb0JBQW9COztBQUd6RCxRQUFRLG1DQUFpQyx3QkFBSSxNQUFNLFFBQUssWUFBWTtBQUNsRSxNQUFJLENBQUMsT0FBTyxzQ0FBc0IsQ0FBQzs7QUFFbkMsTUFBTSxNQUFNLEdBQUcsNEJBQU0sSUFBSSxFQUFFO0FBQ3pCLGVBQVcsRUFBRSxRQUFRO0FBQ3JCLGdCQUFZLEVBQUUsSUFBSTtBQUNsQixxQkFBaUIsRUFBRSxJQUFJO0dBQ3hCLENBQUMsQ0FBQyxNQUFNLENBQUM7O0FBRVYsVUFBUSxDQUFDLGdCQUFnQixFQUFFLFlBQVk7OztBQUNyQyxVQUFNLENBQUM7Ozs7OzZDQUVDLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDOzs7Ozs7O0tBQ2hDLENBQUMsQ0FBQztBQUNILGNBQVUsQ0FBQzthQUFNLGlDQUFZLFFBQVEsRUFBRSxNQUFNLENBQUM7S0FBQSxDQUFDLENBQUM7O0FBRWhELE1BQUUsQ0FBQyw4Q0FBOEMsRUFBRSxZQUFNO0FBQ3ZELGFBQU8sTUFBTSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0tBQzNGLENBQUMsQ0FBQzs7OztBQUlILE1BQUUsQ0FBQyxxREFBcUQsRUFBRTtVQUNwRCxFQUFFOzs7Ozs2Q0FBUyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxXQUFXLENBQUM7OztBQUFoRCxjQUFFOzs2Q0FDQSxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQzs7Ozs2Q0FDaEIsK0JBQVUseUJBQXlCLEVBQUUsTUFBTSxDQUFDOzs7OzZDQUU1QyxzQkFBRSxLQUFLLENBQUMsSUFBSSxDQUFDOzs7OzZDQUNiLE1BQU0sQ0FBQyxXQUFXLEVBQUU7Ozs7NkNBQ3BCLHNCQUFFLEtBQUssQ0FBQyxJQUFJLENBQUM7Ozs7NkNBQ2IsK0JBQVUsbUJBQW1CLEVBQUUsTUFBTSxDQUFDOzs7Ozs7O0tBQzdDLENBQUMsQ0FBQzs7QUFFSCxNQUFFLENBQUMsdUNBQXVDLEVBQUU7VUFDdEMsSUFBSTs7Ozs7NkNBQVMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsYUFBYSxDQUFDOzs7QUFBM0QsZ0JBQUk7OzZDQUNGLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDOzs7OzZDQUNsQixNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxnQkFBZ0IsQ0FBQzs7Ozs2Q0FDMUMsTUFBTSxDQUFDLElBQUksRUFBRTs7Ozs2Q0FDYixNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxnQkFBZ0IsQ0FBQzs7Ozs2Q0FDMUMsTUFBTSxDQUFDLE9BQU8sRUFBRTs7Ozs2Q0FDaEIsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsZ0JBQWdCLENBQUM7Ozs7Ozs7S0FDakQsQ0FBQyxDQUFDOzs7QUFHSCxNQUFFLENBQUMsOEZBQThGLEVBQUU7VUFDN0YsSUFBSTs7Ozs7NkNBQVMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsd0JBQXdCLENBQUM7OztBQUF0RSxnQkFBSTs7NkNBQ0YsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7Ozs7NkNBQ2xCLCtCQUFVLHlCQUF5QixFQUFFLE1BQU0sRUFBRSxFQUFFLENBQUM7Ozs7Ozs7S0FDdkQsQ0FBQyxDQUFDO0dBQ0osQ0FBQyxDQUFDO0NBQ0osQ0FBQyxDQUFDOztBQUVILFFBQVEsbUNBQWlDLHdCQUFJLE1BQU0sb0NBQWlDLFlBQVk7OztBQUM5RixNQUFJLENBQUMsT0FBTyxzQ0FBc0IsQ0FBQzs7QUFFbkMsTUFBTSxNQUFNLEdBQUcsNEJBQU0sSUFBSSxFQUFFO0FBQ3pCLGVBQVcsRUFBRSxRQUFRO0FBQ3JCLHFCQUFpQixFQUFFLEtBQUs7R0FDekIsQ0FBQyxDQUFDLE1BQU0sQ0FBQzs7QUFFVixRQUFNLENBQUM7Ozs7OzJDQUVDLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDOzs7Ozs7O0dBQ2hDLENBQUMsQ0FBQztBQUNILFlBQVUsQ0FBQzs7Ozs7MkNBQWtCLGlDQUFZLFFBQVEsRUFBRSxNQUFNLENBQUM7Ozs7Ozs7Ozs7R0FBQSxDQUFDLENBQUM7O0FBRTVELElBQUUsQ0FBQyw2Q0FBNkMsRUFBRTs7Ozs7MkNBQzFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsNkNBQTZDLENBQUM7Ozs7MkNBQzdELCtCQUFVLHlCQUF5QixFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxRQUFROzs7Ozs7O0dBQ3BGLENBQUMsQ0FBQztDQUNKLENBQUMsQ0FBQyIsImZpbGUiOiJ0ZXN0L2UyZS9zYWZhcmkvd2luZG93cy1mcmFtZS1zcGVjcy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBzZXR1cCBmcm9tIFwiLi4vc2V0dXAtYmFzZVwiO1xuaW1wb3J0IGVudiBmcm9tICcuLi9oZWxwZXJzL2Vudic7XG5pbXBvcnQgeyBsb2FkV2ViVmlldywgc3BpblRpdGxlIH0gZnJvbSBcIi4uL2hlbHBlcnMvd2Vidmlld1wiO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgTU9DSEFfU0FGQVJJX1RJTUVPVVQgfSBmcm9tICcuLi9oZWxwZXJzL3Nlc3Npb24nO1xuXG5cbmRlc2NyaWJlKGBzYWZhcmkgLSB3aW5kb3dzIGFuZCBmcmFtZXMgKCR7ZW52LkRFVklDRX0pYCwgZnVuY3Rpb24gKCkge1xuICB0aGlzLnRpbWVvdXQoTU9DSEFfU0FGQVJJX1RJTUVPVVQpO1xuXG4gIGNvbnN0IGRyaXZlciA9IHNldHVwKHRoaXMsIHtcbiAgICBicm93c2VyTmFtZTogJ3NhZmFyaScsXG4gICAgbmF0aXZlV2ViVGFwOiB0cnVlLFxuICAgIHNhZmFyaUFsbG93UG9wdXBzOiB0cnVlXG4gIH0pLmRyaXZlcjtcblxuICBkZXNjcmliZSgnd2l0aGluIHdlYnZpZXcnLCBmdW5jdGlvbiAoKSB7XG4gICAgYmVmb3JlKGFzeW5jICgpID0+IHtcbiAgICAgIC8vIG1pbmltaXplIHdhaXRpbmcgaWYgc29tZXRoaW5nIGdvZXMgd3JvbmdcbiAgICAgIGF3YWl0IGRyaXZlci5pbXBsaWNpdFdhaXQoMTAwMCk7XG4gICAgfSk7XG4gICAgYmVmb3JlRWFjaCgoKSA9PiBsb2FkV2ViVmlldyhcInNhZmFyaVwiLCBkcml2ZXIpKTtcblxuICAgIGl0KFwic2hvdWxkIHRocm93IG5vc3VjaHdpbmRvdyBpZiB0aGVyZSdzIG5vdCBvbmVcIiwgKCkgPT4ge1xuICAgICAgcmV0dXJuIGRyaXZlci5zZXRXaW5kb3coJ25vZXhpc3RtYW4nKS5zaG91bGQuYmUucmVqZWN0ZWRXaXRoKC93aW5kb3cgY291bGQgbm90IGJlIGZvdW5kLyk7XG4gICAgfSk7XG5cbiAgICAvLyB1bmZvcnR1bmF0ZWx5LCBpT1M4IGRvZXNuJ3QgcmVzcG9uZCB0byB0aGUgY2xvc2UoKSBtZXRob2Qgb24gd2luZG93XG4gICAgLy8gdGhlIHdheSBpT1M3IGRvZXNcbiAgICBpdChcInNob3VsZCBiZSBhYmxlIHRvIG9wZW4gYW5kIGNsb3NlIHdpbmRvd3MgQHNraXAtaW9zOFwiLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgZWwgPSBhd2FpdCBkcml2ZXIuZmluZEVsZW1lbnQoJ2lkJywgJ2JsYW5rbGluaycpO1xuICAgICAgYXdhaXQgZHJpdmVyLmNsaWNrKGVsKTtcbiAgICAgIGF3YWl0IHNwaW5UaXRsZShcIkkgYW0gYW5vdGhlciBwYWdlIHRpdGxlXCIsIGRyaXZlcik7XG5cbiAgICAgIGF3YWl0IEIuZGVsYXkoMjAwMCk7XG4gICAgICBhd2FpdCBkcml2ZXIuY2xvc2VXaW5kb3coKTtcbiAgICAgIGF3YWl0IEIuZGVsYXkoMzAwMCk7XG4gICAgICBhd2FpdCBzcGluVGl0bGUoXCJJIGFtIGEgcGFnZSB0aXRsZVwiLCBkcml2ZXIpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBiZSBhYmxlIHRvIGdvIGJhY2sgYW5kIGZvcndhcmQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgbGluayA9IGF3YWl0IGRyaXZlci5maW5kRWxlbWVudCgnbGluayB0ZXh0JywgJ2kgYW0gYSBsaW5rJyk7XG4gICAgICBhd2FpdCBkcml2ZXIuY2xpY2sobGluayk7XG4gICAgICBhd2FpdCBkcml2ZXIuZmluZEVsZW1lbnQoJ2lkJywgJ29ubHlfb25fcGFnZV8yJyk7XG4gICAgICBhd2FpdCBkcml2ZXIuYmFjaygpO1xuICAgICAgYXdhaXQgZHJpdmVyLmZpbmRFbGVtZW50KCdpZCcsICdpX2FtX2FfdGV4dGJveCcpO1xuICAgICAgYXdhaXQgZHJpdmVyLmZvcndhcmQoKTtcbiAgICAgIGF3YWl0IGRyaXZlci5maW5kRWxlbWVudCgnaWQnLCAnb25seV9vbl9wYWdlXzInKTtcbiAgICB9KTtcblxuICAgIC8vIGJyb2tlbiBvbiByZWFsIGRldmljZXMsIHNlZSBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9pc3N1ZXMvNTE2N1xuICAgIGl0KFwic2hvdWxkIGJlIGFibGUgdG8gb3BlbiBqcyBwb3B1cCB3aW5kb3dzIHdpdGggc2FmYXJpQWxsb3dQb3B1cHMgc2V0IHRvIHRydWUgQHNraXAtcmVhbC1kZXZpY2VcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IGxpbmsgPSBhd2FpdCBkcml2ZXIuZmluZEVsZW1lbnQoJ2xpbmsgdGV4dCcsICdpIGFtIGEgbmV3IHdpbmRvdyBsaW5rJyk7XG4gICAgICBhd2FpdCBkcml2ZXIuY2xpY2sobGluayk7XG4gICAgICBhd2FpdCBzcGluVGl0bGUoXCJJIGFtIGFub3RoZXIgcGFnZSB0aXRsZVwiLCBkcml2ZXIsIDMwKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcblxuZGVzY3JpYmUoYHNhZmFyaSAtIHdpbmRvd3MgYW5kIGZyYW1lcyAoJHtlbnYuREVWSUNFfSkgLSB3aXRob3V0IHNhZmFyaUFsbG93UG9wdXBzYCwgZnVuY3Rpb24gKCkge1xuICB0aGlzLnRpbWVvdXQoTU9DSEFfU0FGQVJJX1RJTUVPVVQpO1xuXG4gIGNvbnN0IGRyaXZlciA9IHNldHVwKHRoaXMsIHtcbiAgICBicm93c2VyTmFtZTogJ3NhZmFyaScsXG4gICAgc2FmYXJpQWxsb3dQb3B1cHM6IGZhbHNlXG4gIH0pLmRyaXZlcjtcblxuICBiZWZvcmUoYXN5bmMgKCkgPT4ge1xuICAgIC8vIG1pbmltaXplIHdhaXRpbmcgaWYgc29tZXRoaW5nIGdvZXMgd3JvbmdcbiAgICBhd2FpdCBkcml2ZXIuaW1wbGljaXRXYWl0KDUwMDApO1xuICB9KTtcbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiBhd2FpdCBsb2FkV2ViVmlldyhcInNhZmFyaVwiLCBkcml2ZXIpKTtcblxuICBpdChcInNob3VsZCBub3QgYmUgYWJsZSB0byBvcGVuIGpzIHBvcHVwIHdpbmRvd3NcIiwgYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGRyaXZlci5leGVjdXRlKFwid2luZG93Lm9wZW4oJy90ZXN0L2d1aW5lYS1waWcyLmh0bWwnLCBudWxsKVwiKTtcbiAgICBhd2FpdCBzcGluVGl0bGUoXCJJIGFtIGFub3RoZXIgcGFnZSB0aXRsZVwiLCBkcml2ZXIsIDUpLnNob3VsZC5ldmVudHVhbGx5LmJlLnJlamVjdGVkO1xuICB9KTtcbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLiJ9
