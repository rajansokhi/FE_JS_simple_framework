require('source-map-support').install();

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _libIwdp = require('../../lib/iwdp');

var _libIwdp2 = _interopRequireDefault(_libIwdp);

var _teen_process = require('teen_process');

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

var expect = _chai2['default'].expect;

var iwdpInstance = undefined;

describe('ios webkit debug proxy class', function () {
  var _this = this;

  this.timeout(20000);

  beforeEach(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          iwdpInstance = new _libIwdp2['default']();

        case 1:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });

  afterEach(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.prev = 0;
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap(iwdpInstance.stop());

        case 3:
          context$2$0.next = 7;
          break;

        case 5:
          context$2$0.prev = 5;
          context$2$0.t0 = context$2$0['catch'](0);

        case 7:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this, [[0, 5]]);
  });

  it('should detect that IWDP is supported on this machine', function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          iwdpInstance.isSupported().should.eventually.be['true'];

        case 1:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should start IWDP and be able to access the main page', function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(iwdpInstance.start());

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap((0, _requestPromise2['default'])(iwdpInstance.endpoint).should.eventually.have.string('<html'));

        case 4:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should not keep running after stop is called', function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(iwdpInstance.start());

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(iwdpInstance.stop());

        case 4:
          (0, _requestPromise2['default'])(iwdpInstance.endpoint).should.be.rejected;

        case 5:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should still start IWDP server if one is started on a different port', function callee$1$0() {
    var process;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          process = new _teen_process.SubProcess('ios_webkit_debug_proxy', ['--config', 'null:56789']);

          process.start();
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(_bluebird2['default'].delay(500));

        case 4:
          context$2$0.next = 6;
          return _regeneratorRuntime.awrap((0, _requestPromise2['default'])('http://localhost:56789/').should.eventually.have.string('<html'));

        case 6:
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap(iwdpInstance.start());

        case 8:
          context$2$0.next = 10;
          return _regeneratorRuntime.awrap((0, _requestPromise2['default'])(iwdpInstance.endpoint).should.eventually.have.string('<html'));

        case 10:
          context$2$0.next = 12;
          return _regeneratorRuntime.awrap(process.stop());

        case 12:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should restart after the process is stopped abruptly', function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(iwdpInstance.start());

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(iwdpInstance.process.stop());

        case 4:
          context$2$0.next = 6;
          return _regeneratorRuntime.awrap(new _bluebird2['default'](function (resolve) {
            iwdpInstance.once('start', resolve);
          }));

        case 6:
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap((0, _requestPromise2['default'])(iwdpInstance.endpoint).should.eventually.have.string('<html'));

        case 8:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should fail after reaching max retries', function callee$1$0() {
    var retries, errorPromise, promise;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(iwdpInstance.start());

        case 2:
          retries = 0;
          errorPromise = new _bluebird2['default'](function (resolve) {
            iwdpInstance.on('error', function () {
              expect(retries).to.equal(10);
              resolve();
            });
          });

        case 4:
          if (!(++retries <= 10)) {
            context$2$0.next = 13;
            break;
          }

          promise = new _bluebird2['default'](function (resolve) {
            iwdpInstance.once('start', function () {
              resolve();
            });
          });
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap(iwdpInstance.process.stop());

        case 8:
          if (!(retries < 10)) {
            context$2$0.next = 11;
            break;
          }

          context$2$0.next = 11;
          return _regeneratorRuntime.awrap(promise);

        case 11:
          context$2$0.next = 4;
          break;

        case 13:
          context$2$0.next = 15;
          return _regeneratorRuntime.awrap(errorPromise);

        case 15:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
});

// It should give up restarting after 10 failed attempts

// Keep stopping the process after it has been started
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdW5pdC9pd2RwLXNwZWNzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7b0JBQ2lCLE1BQU07Ozs7OEJBQ0ksa0JBQWtCOzs7O3VCQUM1QixnQkFBZ0I7Ozs7NEJBQ04sY0FBYzs7OEJBQ3JCLGlCQUFpQjs7Ozt3QkFDdkIsVUFBVTs7OztBQUN4QixrQkFBSyxNQUFNLEVBQUUsQ0FBQztBQUNkLGtCQUFLLEdBQUcsNkJBQWdCLENBQUM7O0lBRWpCLE1BQU0scUJBQU4sTUFBTTs7QUFDZCxJQUFJLFlBQVksWUFBQSxDQUFDOztBQUVqQixRQUFRLENBQUMsOEJBQThCLEVBQUUsWUFBWTs7O0FBQ25ELE1BQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7O0FBRXBCLFlBQVUsQ0FBQzs7OztBQUNULHNCQUFZLEdBQUcsMEJBQVUsQ0FBQzs7Ozs7OztHQUMzQixDQUFDLENBQUM7O0FBRUgsV0FBUyxDQUFDOzs7Ozs7MkNBRUEsWUFBWSxDQUFDLElBQUksRUFBRTs7Ozs7Ozs7Ozs7Ozs7O0dBRTVCLENBQUMsQ0FBQzs7QUFFSCxJQUFFLENBQUMsc0RBQXNELEVBQUU7Ozs7QUFDekQsc0JBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLEVBQUUsUUFBSyxDQUFDOzs7Ozs7O0dBQ3RELENBQUMsQ0FBQzs7QUFFSCxJQUFFLENBQUMsdURBQXVELEVBQUU7Ozs7OzJDQUNwRCxZQUFZLENBQUMsS0FBSyxFQUFFOzs7OzJDQUNwQixpQ0FBUSxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQzs7Ozs7OztHQUM1RSxDQUFDLENBQUM7O0FBRUgsSUFBRSxDQUFDLDhDQUE4QyxFQUFFOzs7OzsyQ0FDM0MsWUFBWSxDQUFDLEtBQUssRUFBRTs7OzsyQ0FDcEIsWUFBWSxDQUFDLElBQUksRUFBRTs7O0FBQ3pCLDJDQUFRLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQzs7Ozs7OztHQUNuRCxDQUFDLENBQUM7O0FBRUgsSUFBRSxDQUFDLHNFQUFzRSxFQUFFO1FBQ3JFLE9BQU87Ozs7QUFBUCxpQkFBTyxHQUFHLDZCQUFlLHdCQUF3QixFQUFFLENBQUMsVUFBVSxFQUFFLFlBQVksQ0FBQyxDQUFDOztBQUNsRixpQkFBTyxDQUFDLEtBQUssRUFBRSxDQUFDOzsyQ0FDVixzQkFBRSxLQUFLLENBQUMsR0FBRyxDQUFDOzs7OzJDQUNaLGlDQUFRLHlCQUF5QixDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQzs7OzsyQ0FDekUsWUFBWSxDQUFDLEtBQUssRUFBRTs7OzsyQ0FDcEIsaUNBQVEsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUM7Ozs7MkNBQ3JFLE9BQU8sQ0FBQyxJQUFJLEVBQUU7Ozs7Ozs7R0FDckIsQ0FBQyxDQUFDOztBQUVILElBQUUsQ0FBQyxzREFBc0QsRUFBRTs7Ozs7MkNBQ25ELFlBQVksQ0FBQyxLQUFLLEVBQUU7Ozs7MkNBQ3BCLFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFOzs7OzJDQUMzQiwwQkFBTSxVQUFDLE9BQU8sRUFBSztBQUN2Qix3QkFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7V0FDckMsQ0FBQzs7OzsyQ0FDSSxpQ0FBUSxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQzs7Ozs7OztHQUM1RSxDQUFDLENBQUM7O0FBRUgsSUFBRSxDQUFDLHdDQUF3QyxFQUFFO1FBRXZDLE9BQU8sRUFHUCxZQUFZLEVBU1YsT0FBTzs7Ozs7MkNBYlAsWUFBWSxDQUFDLEtBQUssRUFBRTs7O0FBQ3RCLGlCQUFPLEdBQUcsQ0FBQztBQUdYLHNCQUFZLEdBQUcsMEJBQU0sVUFBQyxPQUFPLEVBQUs7QUFDcEMsd0JBQVksQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLFlBQU07QUFDN0Isb0JBQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQzdCLHFCQUFPLEVBQUUsQ0FBQzthQUNYLENBQUMsQ0FBQztXQUNKLENBQUM7OztnQkFHSyxFQUFFLE9BQU8sSUFBSSxFQUFFLENBQUE7Ozs7O0FBQ2hCLGlCQUFPLEdBQUcsMEJBQU0sVUFBQyxPQUFPLEVBQUs7QUFDL0Isd0JBQVksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFlBQU07QUFDL0IscUJBQU8sRUFBRSxDQUFDO2FBQ1gsQ0FBQyxDQUFDO1dBQ0osQ0FBQzs7MkNBQ0ksWUFBWSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUU7OztnQkFDN0IsT0FBTyxHQUFHLEVBQUUsQ0FBQTs7Ozs7OzJDQUNSLE9BQU87Ozs7Ozs7OzJDQUlYLFlBQVk7Ozs7Ozs7R0FDbkIsQ0FBQyxDQUFDO0NBQ0osQ0FBQyxDQUFDIiwiZmlsZSI6InRlc3QvdW5pdC9pd2RwLXNwZWNzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHJhbnNwaWxlOm1vY2hhXG5pbXBvcnQgY2hhaSBmcm9tICdjaGFpJztcbmltcG9ydCBjaGFpQXNQcm9taXNlZCBmcm9tICdjaGFpLWFzLXByb21pc2VkJztcbmltcG9ydCBJV0RQIGZyb20gJy4uLy4uL2xpYi9pd2RwJztcbmltcG9ydCB7IFN1YlByb2Nlc3MgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdC1wcm9taXNlJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmNoYWkuc2hvdWxkKCk7XG5jaGFpLnVzZShjaGFpQXNQcm9taXNlZCk7XG5cbmNvbnN0IHsgZXhwZWN0IH0gPSBjaGFpO1xubGV0IGl3ZHBJbnN0YW5jZTtcblxuZGVzY3JpYmUoJ2lvcyB3ZWJraXQgZGVidWcgcHJveHkgY2xhc3MnLCBmdW5jdGlvbiAoKSB7XG4gIHRoaXMudGltZW91dCgyMDAwMCk7XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgaXdkcEluc3RhbmNlID0gbmV3IElXRFAoKTtcbiAgfSk7XG5cbiAgYWZ0ZXJFYWNoKGFzeW5jICgpID0+IHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgaXdkcEluc3RhbmNlLnN0b3AoKTtcbiAgICB9IGNhdGNoIChpZ24pIHsgfVxuICB9KTtcblxuICBpdCgnc2hvdWxkIGRldGVjdCB0aGF0IElXRFAgaXMgc3VwcG9ydGVkIG9uIHRoaXMgbWFjaGluZScsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBpd2RwSW5zdGFuY2UuaXNTdXBwb3J0ZWQoKS5zaG91bGQuZXZlbnR1YWxseS5iZS50cnVlO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHN0YXJ0IElXRFAgYW5kIGJlIGFibGUgdG8gYWNjZXNzIHRoZSBtYWluIHBhZ2UnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgYXdhaXQgaXdkcEluc3RhbmNlLnN0YXJ0KCk7XG4gICAgYXdhaXQgcmVxdWVzdChpd2RwSW5zdGFuY2UuZW5kcG9pbnQpLnNob3VsZC5ldmVudHVhbGx5LmhhdmUuc3RyaW5nKCc8aHRtbCcpOyBcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBub3Qga2VlcCBydW5uaW5nIGFmdGVyIHN0b3AgaXMgY2FsbGVkJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGF3YWl0IGl3ZHBJbnN0YW5jZS5zdGFydCgpO1xuICAgIGF3YWl0IGl3ZHBJbnN0YW5jZS5zdG9wKCk7XG4gICAgcmVxdWVzdChpd2RwSW5zdGFuY2UuZW5kcG9pbnQpLnNob3VsZC5iZS5yZWplY3RlZDtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBzdGlsbCBzdGFydCBJV0RQIHNlcnZlciBpZiBvbmUgaXMgc3RhcnRlZCBvbiBhIGRpZmZlcmVudCBwb3J0JywgYXN5bmMgZnVuY3Rpb24oKSB7XG4gICAgbGV0IHByb2Nlc3MgPSBuZXcgU3ViUHJvY2VzcygnaW9zX3dlYmtpdF9kZWJ1Z19wcm94eScsIFsnLS1jb25maWcnLCAnbnVsbDo1Njc4OSddKTtcbiAgICBwcm9jZXNzLnN0YXJ0KCk7XG4gICAgYXdhaXQgQi5kZWxheSg1MDApO1xuICAgIGF3YWl0IHJlcXVlc3QoJ2h0dHA6Ly9sb2NhbGhvc3Q6NTY3ODkvJykuc2hvdWxkLmV2ZW50dWFsbHkuaGF2ZS5zdHJpbmcoJzxodG1sJyk7XG4gICAgYXdhaXQgaXdkcEluc3RhbmNlLnN0YXJ0KCk7XG4gICAgYXdhaXQgcmVxdWVzdChpd2RwSW5zdGFuY2UuZW5kcG9pbnQpLnNob3VsZC5ldmVudHVhbGx5LmhhdmUuc3RyaW5nKCc8aHRtbCcpO1xuICAgIGF3YWl0IHByb2Nlc3Muc3RvcCgpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHJlc3RhcnQgYWZ0ZXIgdGhlIHByb2Nlc3MgaXMgc3RvcHBlZCBhYnJ1cHRseScsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBhd2FpdCBpd2RwSW5zdGFuY2Uuc3RhcnQoKTtcbiAgICBhd2FpdCBpd2RwSW5zdGFuY2UucHJvY2Vzcy5zdG9wKCk7XG4gICAgYXdhaXQgbmV3IEIoKHJlc29sdmUpID0+IHtcbiAgICAgIGl3ZHBJbnN0YW5jZS5vbmNlKCdzdGFydCcsIHJlc29sdmUpO1xuICAgIH0pO1xuICAgIGF3YWl0IHJlcXVlc3QoaXdkcEluc3RhbmNlLmVuZHBvaW50KS5zaG91bGQuZXZlbnR1YWxseS5oYXZlLnN0cmluZygnPGh0bWwnKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBmYWlsIGFmdGVyIHJlYWNoaW5nIG1heCByZXRyaWVzJywgYXN5bmMgKCkgID0+IHtcbiAgICBhd2FpdCBpd2RwSW5zdGFuY2Uuc3RhcnQoKTtcbiAgICBsZXQgcmV0cmllcyA9IDA7XG5cbiAgICAvLyBJdCBzaG91bGQgZ2l2ZSB1cCByZXN0YXJ0aW5nIGFmdGVyIDEwIGZhaWxlZCBhdHRlbXB0c1xuICAgIGxldCBlcnJvclByb21pc2UgPSBuZXcgQigocmVzb2x2ZSkgPT4ge1xuICAgICAgaXdkcEluc3RhbmNlLm9uKCdlcnJvcicsICgpID0+IHtcbiAgICAgICAgZXhwZWN0KHJldHJpZXMpLnRvLmVxdWFsKDEwKTtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICAvLyBLZWVwIHN0b3BwaW5nIHRoZSBwcm9jZXNzIGFmdGVyIGl0IGhhcyBiZWVuIHN0YXJ0ZWRcbiAgICB3aGlsZSAoKytyZXRyaWVzIDw9IDEwKSB7XG4gICAgICBsZXQgcHJvbWlzZSA9IG5ldyBCKChyZXNvbHZlKSA9PiB7XG4gICAgICAgIGl3ZHBJbnN0YW5jZS5vbmNlKCdzdGFydCcsICgpID0+IHtcbiAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgICBhd2FpdCBpd2RwSW5zdGFuY2UucHJvY2Vzcy5zdG9wKCk7XG4gICAgICBpZiAocmV0cmllcyA8IDEwKSB7XG4gICAgICAgIGF3YWl0IHByb21pc2U7XG4gICAgICB9XG4gICAgfVxuXG4gICAgYXdhaXQgZXJyb3JQcm9taXNlO1xuICB9KTtcbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
