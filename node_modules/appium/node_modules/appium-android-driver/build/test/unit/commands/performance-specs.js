'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _this = this;

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _2 = require('../../..');

var _3 = _interopRequireDefault(_2);

var _libCommandsPerformanceJs = require('../../../lib/commands/performance.js');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumTestSupport = require('appium-test-support');

var _appiumAdb = require('appium-adb');

var _appiumAdb2 = _interopRequireDefault(_appiumAdb);

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

var PACKAGE_NAME = 'io.appium.android.apis';

var adb = new _appiumAdb2['default']();
var driver = new _3['default']();
driver.adb = adb;

describe('getperformancedata', (0, _appiumTestSupport.withMocks)({ adb: adb }, function (mocks) {
  it('should get the list of available getPerformance data type', function () {
    var types = driver.getPerformanceDataTypes();
    types.should.eql(_lodash2['default'].keys(_libCommandsPerformanceJs.SUPPORTED_PERFORMANCE_DATA_TYPES));
  });

  function runTest(type, expectedKeys, expectedData) {
    var data;
    return _regeneratorRuntime.async(function runTest$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(driver.getPerformanceData(PACKAGE_NAME, type));

        case 2:
          data = context$2$0.sent;

          // make sure we got something
          Array.isArray(data).should.be['true'];
          data.length.should.eql(2);

          data[0].should.eql(expectedKeys);
          data[1].should.eql(expectedData);

        case 7:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  }

  var types = [{
    cmd: 'cpuinfo',
    description: 'the amount of cpu by user and kernel process',
    args: ['dumpsys', 'cpuinfo', '|', 'grep', '\'' + PACKAGE_NAME + '\''],
    dumpsysData: ' +0% 2209/io.appium.android.apis: 14% user + 23% kernel',
    keys: _libCommandsPerformanceJs.CPU_KEYS,
    data: ['14', '23']
  }, {
    cmd: 'memoryinfo',
    description: 'the amount of memory used by the process (API level 19)',
    args: ['dumpsys', 'meminfo', '\'' + PACKAGE_NAME + '\'', '|', 'grep', '-E', "'Native|Dalvik|EGL|GL|TOTAL'"],
    dumpsysData: '  Native Heap     2469     2332        0        0    20480    13920     6559\n   Dalvik Heap      873      808        0        0     1526      578      948\n  Dalvik Other      148      148        0        0\n         TOTAL     7757     4012      976        0    22006    14498     7507',
    keys: _libCommandsPerformanceJs.MEMORY_KEYS,
    data: ['4012', '2332', '808', undefined, undefined, '7757', '2469', '873', undefined, undefined, '13920', '20480'],
    apiLevel: '19'
  }, {
    cmd: 'memoryinfo',
    description: 'the amount of memory used by the process (API level 19)',
    args: ['dumpsys', 'meminfo', '\'' + PACKAGE_NAME + '\'', '|', 'grep', '-E', "'Native|Dalvik|EGL|GL|TOTAL'"],
    dumpsysData: 'Native|Dalvik|EGL|GL|TOTAL\'\n       Native     1050     1236      968     7580     7428       31\n       Dalvik     2637     5592     2288     3960     3453      507\n        TOTAL     6796    11688     4288    11540    10881      538',
    keys: _libCommandsPerformanceJs.MEMORY_KEYS,
    data: ['4288', '968', '2288', undefined, undefined, '6796', '1050', '2637', undefined, undefined, '7428', '7580'],
    apiLevel: '18'
  }, {
    cmd: 'batteryinfo',
    description: 'the remaining battery power',
    args: ['dumpsys', 'battery', '|', 'grep', 'level'],
    dumpsysData: '  level: 47',
    keys: _libCommandsPerformanceJs.BATTERY_KEYS,
    data: ['47']
  }];
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    var _loop = function () {
      var type = _step.value;

      describe(type.cmd, function () {
        afterEach(function () {
          mocks.adb.verify();
        });
        it('should get ' + type.description, function callee$3$0() {
          return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
            while (1) switch (context$4$0.prev = context$4$0.next) {
              case 0:
                if (type.apiLevel) {
                  mocks.adb.expects('getApiLevel').returns(type.apiLevel);
                }
                mocks.adb.expects('shell').withExactArgs(type.args).returns(type.dumpsysData);
                context$4$0.next = 4;
                return _regeneratorRuntime.awrap(runTest(type.cmd, type.keys, type.data));

              case 4:
              case 'end':
                return context$4$0.stop();
            }
          }, null, _this);
        });
        it('should retry if the data is not initially found', function callee$3$0() {
          return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
            while (1) switch (context$4$0.prev = context$4$0.next) {
              case 0:
                if (type.apiLevel) {
                  mocks.adb.expects('getApiLevel').returns(type.apiLevel);
                }
                mocks.adb.expects('shell').twice().withExactArgs(type.args).onCall(0).returns().onCall(1).returns(type.dumpsysData);
                context$4$0.next = 4;
                return _regeneratorRuntime.awrap(runTest(type.cmd, type.keys, type.data));

              case 4:
              case 'end':
                return context$4$0.stop();
            }
          }, null, _this);
        });
        it('should error out if too many failures', function callee$3$0() {
          return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
            while (1) switch (context$4$0.prev = context$4$0.next) {
              case 0:
                mocks.adb.expects('shell').twice().withExactArgs(type.args).onCall(0).returns().onCall(1).returns();
                context$4$0.next = 3;
                return _regeneratorRuntime.awrap(runTest(type.cmd, type.keys, type.data).should.be.rejected);

              case 3:
              case 'end':
                return context$4$0.stop();
            }
          }, null, _this);
        });
      });
    };

    for (var _iterator = _getIterator(types), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      _loop();
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator['return']) {
        _iterator['return']();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  describe.skip('networkinfo', function () {
    it('should get the network statistics', function () {
      var returnValue = [['bucketStart', 'activeTime', 'rxBytes', 'rxPackets', 'txBytes', 'txPackets', 'operations', 'bucketDuration'], [1478091600000, 1099075, 610947, 928, 114362, 769, 0, 3600000], [1478095200000, 1306300, 405997, 509, 46359, 370, 0, 3600000]];
      mocks.driver.expects('getPerformanceData').withExactArgs('io.appium.android.apis', 'networkinfo', 1000).returns(returnValue);
      var network = driver.getPerformanceData('io.appium.android.apis', 'networkinfo', 1000);
      network.length.should.be.above(0);
      var compare = false;

      for (var j = 0; j < _libCommandsPerformanceJs.NETWORK_KEYS.length; ++j) {
        if (_lodash2['default'].isEqual(_libCommandsPerformanceJs.NETWORK_KEYS[j], network[0])) {
          compare = true;
        }
      }

      compare.should.equal(true);

      if (network.length > 1) {
        for (var i = 1; i < network.length; ++i) {
          network[0].length.should.equal(network[i].length);
        }
      }
    });
  });
}));
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdW5pdC9jb21tYW5kcy9wZXJmb3JtYW5jZS1zcGVjcy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O29CQUFpQixNQUFNOzs7OzhCQUNJLGtCQUFrQjs7OztpQkFDbkIsVUFBVTs7Ozt3Q0FFVCxzQ0FBc0M7O3NCQUNuRCxRQUFROzs7O2lDQUNJLHFCQUFxQjs7eUJBQy9CLFlBQVk7Ozs7QUFHNUIsa0JBQUssTUFBTSxFQUFFLENBQUM7QUFDZCxrQkFBSyxHQUFHLDZCQUFnQixDQUFDOztBQUV6QixJQUFNLFlBQVksR0FBRyx3QkFBd0IsQ0FBQzs7QUFFOUMsSUFBSSxHQUFHLEdBQUcsNEJBQVMsQ0FBQztBQUNwQixJQUFJLE1BQU0sR0FBRyxtQkFBbUIsQ0FBQztBQUNqQyxNQUFNLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQzs7QUFFakIsUUFBUSxDQUFDLG9CQUFvQixFQUFFLGtDQUFVLEVBQUMsR0FBRyxFQUFILEdBQUcsRUFBQyxFQUFFLFVBQUMsS0FBSyxFQUFLO0FBQ3pELElBQUUsQ0FBQywyREFBMkQsRUFBRSxZQUFNO0FBQ3BFLFFBQUksS0FBSyxHQUFHLE1BQU0sQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO0FBQzdDLFNBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLG9CQUFFLElBQUksNERBQWtDLENBQUMsQ0FBQztHQUM1RCxDQUFDLENBQUM7O0FBRUgsV0FBZSxPQUFPLENBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxZQUFZO1FBQ2xELElBQUk7Ozs7OzJDQUFTLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDOzs7QUFBMUQsY0FBSTs7O0FBR1IsZUFBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxRQUFLLENBQUM7QUFDbkMsY0FBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDOztBQUUxQixjQUFJLENB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RUFBRTtBQUN0QixhQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBQztBQUN0QyxpQkFBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNuRDtPQUNGO0tBQ0YsQ0FBQyxDQUFDO0dBQ0osQ0FBQyxDQUFDO0NBQ0osQ0FBQyxDQUFDLENBQUMiLCJmaWxlIjoidGVzdC91bml0L2NvbW1hbmRzL3BlcmZvcm1hbmNlLXNwZWNzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNoYWkgZnJvbSAnY2hhaSc7XG5pbXBvcnQgY2hhaUFzUHJvbWlzZWQgZnJvbSAnY2hhaS1hcy1wcm9taXNlZCc7XG5pbXBvcnQgQW5kcm9pZERyaXZlciBmcm9tICcuLi8uLi8uLic7XG5pbXBvcnQgeyBTVVBQT1JURURfUEVSRk9STUFOQ0VfREFUQV9UWVBFUywgTkVUV09SS19LRVlTLCBDUFVfS0VZUywgQkFUVEVSWV9LRVlTLFxuICAgICAgICAgTUVNT1JZX0tFWVN9IGZyb20gJy4uLy4uLy4uL2xpYi9jb21tYW5kcy9wZXJmb3JtYW5jZS5qcyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgd2l0aE1vY2tzIH0gZnJvbSAnYXBwaXVtLXRlc3Qtc3VwcG9ydCc7XG5pbXBvcnQgQURCIGZyb20gJ2FwcGl1bS1hZGInO1xuXG5cbmNoYWkuc2hvdWxkKCk7XG5jaGFpLnVzZShjaGFpQXNQcm9taXNlZCk7XG5cbmNvbnN0IFBBQ0tBR0VfTkFNRSA9ICdpby5hcHBpdW0uYW5kcm9pZC5hcGlzJztcblxubGV0IGFkYiA9IG5ldyBBREIoKTtcbmxldCBkcml2ZXIgPSBuZXcgQW5kcm9pZERyaXZlcigpO1xuZHJpdmVyLmFkYiA9IGFkYjtcblxuZGVzY3JpYmUoJ2dldHBlcmZvcm1hbmNlZGF0YScsIHdpdGhNb2Nrcyh7YWRifSwgKG1vY2tzKSA9PiB7XG4gIGl0KCdzaG91bGQgZ2V0IHRoZSBsaXN0IG9mIGF2YWlsYWJsZSBnZXRQZXJmb3JtYW5jZSBkYXRhIHR5cGUnLCAoKSA9PiB7XG4gICAgbGV0IHR5cGVzID0gZHJpdmVyLmdldFBlcmZvcm1hbmNlRGF0YVR5cGVzKCk7XG4gICAgdHlwZXMuc2hvdWxkLmVxbChfLmtleXMoU1VQUE9SVEVEX1BFUkZPUk1BTkNFX0RBVEFfVFlQRVMpKTtcbiAgfSk7XG5cbiAgYXN5bmMgZnVuY3Rpb24gcnVuVGVzdCAodHlwZSwgZXhwZWN0ZWRLZXlzLCBleHBlY3RlZERhdGEpIHtcbiAgICBsZXQgZGF0YSA9IGF3YWl0IGRyaXZlci5nZXRQZXJmb3JtYW5jZURhdGEoUEFDS0FHRV9OQU1FLCB0eXBlKTtcblxuICAgIC8vIG1ha2Ugc3VyZSB3ZSBnb3Qgc29tZXRoaW5nXG4gICAgQXJyYXkuaXNBcnJheShkYXRhKS5zaG91bGQuYmUudHJ1ZTtcbiAgICBkYXRhLmxlbmd0aC5zaG91bGQuZXFsKDIpO1xuXG4gICAgZGF0YVswXS5zaG91bGQuZXFsKGV4cGVjdGVkS2V5cyk7XG4gICAgZGF0YVsxXS5zaG91bGQuZXFsKGV4cGVjdGVkRGF0YSk7XG4gIH1cblxuICBsZXQgdHlwZXMgPSBbXG4gICAge1xuICAgICAgY21kOiAnY3B1aW5mbycsXG4gICAgICBkZXNjcmlwdGlvbjogJ3RoZSBhbW91bnQgb2YgY3B1IGJ5IHVzZXIgYW5kIGtlcm5lbCBwcm9jZXNzJyxcbiAgICAgIGFyZ3M6IFsnZHVtcHN5cycsICdjcHVpbmZvJywgJ3wnLCAnZ3JlcCcsIGAnJHtQQUNLQUdFX05BTUV9J2BdLFxuICAgICAgZHVtcHN5c0RhdGE6IGAgKzAlIDIyMDkvaW8uYXBwaXVtLmFuZHJvaWQuYXBpczogMTQlIHVzZXIgKyAyMyUga2VybmVsYCxcbiAgICAgIGtleXM6IENQVV9LRVlTLFxuICAgICAgZGF0YTogWycxNCcsICcyMyddLFxuICAgIH0sXG4gICAge1xuICAgICAgY21kOiAnbWVtb3J5aW5mbycsXG4gICAgICBkZXNjcmlwdGlvbjogJ3RoZSBhbW91bnQgb2YgbWVtb3J5IHVzZWQgYnkgdGhlIHByb2Nlc3MgKEFQSSBsZXZlbCAxOSknLFxuICAgICAgYXJnczogWydkdW1wc3lzJywgJ21lbWluZm8nLCBgJyR7UEFDS0FHRV9OQU1FfSdgLCAnfCcsICdncmVwJywgJy1FJywgXCInTmF0aXZlfERhbHZpa3xFR0x8R0x8VE9UQUwnXCJdLFxuICAgICAgZHVtcHN5c0RhdGE6IGAgIE5hdGl2ZSBIZWFwICAgICAyNDY5ICAgICAyMzMyICAgICAgICAwICAgICAgICAwICAgIDIwNDgwICAgIDEzOTIwICAgICA2NTU5XG4gICBEYWx2aWsgSGVhcCAgICAgIDg3MyAgICAgIDgwOCAgICAgICAgMCAgICAgICAgMCAgICAgMTUyNiAgICAgIDU3OCAgICAgIDk0OFxuICBEYWx2aWsgT3RoZXIgICAgICAxNDggICAgICAxNDggICAgICAgIDAgICAgICAgIDBcbiAgICAgICAgIFRPVEFMICAgICA3NzU3ICAgICA0MDEyICAgICAgOTc2ICAgICAgICAwICAgIDIyMDA2ICAgIDE0NDk4ICAgICA3NTA3YCxcbiAgICAgIGtleXM6IE1FTU9SWV9LRVlTLFxuICAgICAgZGF0YTogWyc0MDEyJywgJzIzMzInLCAnODA4JywgdW5kZWZpbmVkLCB1bmRlZmluZWQsXG4gICAgICAgICAgICAgJzc3NTcnLCAnMjQ2OScsICc4NzMnLCB1bmRlZmluZWQsIHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAnMTM5MjAnLCAnMjA0ODAnXSxcbiAgICAgIGFwaUxldmVsOiAnMTknLFxuICAgIH0sXG4gICAge1xuICAgICAgY21kOiAnbWVtb3J5aW5mbycsXG4gICAgICBkZXNjcmlwdGlvbjogJ3RoZSBhbW91bnQgb2YgbWVtb3J5IHVzZWQgYnkgdGhlIHByb2Nlc3MgKEFQSSBsZXZlbCAxOSknLFxuICAgICAgYXJnczogWydkdW1wc3lzJywgJ21lbWluZm8nLCBgJyR7UEFDS0FHRV9OQU1FfSdgLCAnfCcsICdncmVwJywgJy1FJywgXCInTmF0aXZlfERhbHZpa3xFR0x8R0x8VE9UQUwnXCJdLFxuICAgICAgZHVtcHN5c0RhdGE6IGBOYXRpdmV8RGFsdmlrfEVHTHxHTHxUT1RBTCdcbiAgICAgICBOYXRpdmUgICAgIDEwNTAgICAgIDEyMzYgICAgICA5NjggICAgIDc1ODAgICAgIDc0MjggICAgICAgMzFcbiAgICAgICBEYWx2aWsgICAgIDI2MzcgICAgIDU1OTIgICAgIDIyODggICAgIDM5NjAgICAgIDM0NTMgICAgICA1MDdcbiAgICAgICAgVE9UQUwgICAgIDY3OTYgICAgMTE2ODggICAgIDQyODggICAgMTE1NDAgICAgMTA4ODEgICAgICA1MzhgLFxuICAgICAga2V5czogTUVNT1JZX0tFWVMsXG4gICAgICBkYXRhOiBbJzQyODgnLCAnOTY4JywgJzIyODgnLCB1bmRlZmluZWQsIHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAnNjc5NicsICcxMDUwJywgJzI2MzcnLCB1bmRlZmluZWQsIHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAnNzQyOCcsICc3NTgwJ10sXG4gICAgICBhcGlMZXZlbDogJzE4JyxcbiAgICB9LFxuICAgIHtcbiAgICAgIGNtZDogJ2JhdHRlcnlpbmZvJyxcbiAgICAgIGRlc2NyaXB0aW9uOiAndGhlIHJlbWFpbmluZyBiYXR0ZXJ5IHBvd2VyJyxcbiAgICAgIGFyZ3M6IFsnZHVtcHN5cycsICdiYXR0ZXJ5JywgJ3wnLCAnZ3JlcCcsICdsZXZlbCddLFxuICAgICAgZHVtcHN5c0RhdGE6ICcgIGxldmVsOiA0NycsXG4gICAgICBrZXlzOiBCQVRURVJZX0tFWVMsXG4gICAgICBkYXRhOiBbJzQ3J10sXG4gICAgfSxcbiAgXTtcbiAgZm9yIChsZXQgdHlwZSBvZiB0eXBlcykge1xuICAgIGRlc2NyaWJlKHR5cGUuY21kLCAoKSA9PiB7XG4gICAgICBhZnRlckVhY2goKCkgPT4ge1xuICAgICAgICBtb2Nrcy5hZGIudmVyaWZ5KCk7XG4gICAgICB9KTtcbiAgICAgIGl0KGBzaG91bGQgZ2V0ICR7dHlwZS5kZXNjcmlwdGlvbn1gLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGlmICh0eXBlLmFwaUxldmVsKSB7XG4gICAgICAgICAgbW9ja3MuYWRiXG4gICAgICAgICAgICAuZXhwZWN0cygnZ2V0QXBpTGV2ZWwnKVxuICAgICAgICAgICAgLnJldHVybnModHlwZS5hcGlMZXZlbCk7XG4gICAgICAgIH1cbiAgICAgICAgbW9ja3MuYWRiXG4gICAgICAgICAgLmV4cGVjdHMoJ3NoZWxsJylcbiAgICAgICAgICAud2l0aEV4YWN0QXJncyh0eXBlLmFyZ3MpXG4gICAgICAgICAgLnJldHVybnModHlwZS5kdW1wc3lzRGF0YSk7XG4gICAgICAgIGF3YWl0IHJ1blRlc3QodHlwZS5jbWQsIHR5cGUua2V5cywgdHlwZS5kYXRhKTtcbiAgICAgIH0pO1xuICAgICAgaXQoJ3Nob3VsZCByZXRyeSBpZiB0aGUgZGF0YSBpcyBub3QgaW5pdGlhbGx5IGZvdW5kJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBpZiAodHlwZS5hcGlMZXZlbCkge1xuICAgICAgICAgIG1vY2tzLmFkYlxuICAgICAgICAgICAgLmV4cGVjdHMoJ2dldEFwaUxldmVsJylcbiAgICAgICAgICAgIC5yZXR1cm5zKHR5cGUuYXBpTGV2ZWwpO1xuICAgICAgICB9XG4gICAgICAgIG1vY2tzLmFkYlxuICAgICAgICAgIC5leHBlY3RzKCdzaGVsbCcpXG4gICAgICAgICAgLnR3aWNlKClcbiAgICAgICAgICAud2l0aEV4YWN0QXJncyh0eXBlLmFyZ3MpXG4gICAgICAgICAgLm9uQ2FsbCgwKVxuICAgICAgICAgICAgLnJldHVybnMoKVxuICAgICAgICAgIC5vbkNhbGwoMSlcbiAgICAgICAgICAgIC5yZXR1cm5zKHR5cGUuZHVtcHN5c0RhdGEpO1xuICAgICAgICBhd2FpdCBydW5UZXN0KHR5cGUuY21kLCB0eXBlLmtleXMsIHR5cGUuZGF0YSk7XG4gICAgICB9KTtcbiAgICAgIGl0KCdzaG91bGQgZXJyb3Igb3V0IGlmIHRvbyBtYW55IGZhaWx1cmVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBtb2Nrcy5hZGJcbiAgICAgICAgICAuZXhwZWN0cygnc2hlbGwnKVxuICAgICAgICAgIC50d2ljZSgpXG4gICAgICAgICAgLndpdGhFeGFjdEFyZ3ModHlwZS5hcmdzKVxuICAgICAgICAgIC5vbkNhbGwoMClcbiAgICAgICAgICAgIC5yZXR1cm5zKClcbiAgICAgICAgICAub25DYWxsKDEpXG4gICAgICAgICAgICAucmV0dXJucygpO1xuICAgICAgICBhd2FpdCBydW5UZXN0KHR5cGUuY21kLCB0eXBlLmtleXMsIHR5cGUuZGF0YSkuc2hvdWxkLmJlLnJlamVjdGVkO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBkZXNjcmliZS5za2lwKCduZXR3b3JraW5mbycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGdldCB0aGUgbmV0d29yayBzdGF0aXN0aWNzJywgKCkgPT4ge1xuICAgICAgbGV0IHJldHVyblZhbHVlID0gW1snYnVja2V0U3RhcnQnLCAnYWN0aXZlVGltZScsICdyeEJ5dGVzJywgJ3J4UGFja2V0cycsICd0eEJ5dGVzJywgJ3R4UGFja2V0cycsICdvcGVyYXRpb25zJywgJ2J1Y2tldER1cmF0aW9uJ10sIFsxNDc4MDkxNjAwMDAwLCAxMDk5MDc1LCA2MTA5NDcsIDkyOCwgMTE0MzYyLCA3NjksIDAsIDM2MDAwMDBdLCBbMTQ3ODA5NTIwMDAwMCwgMTMwNjMwMCwgNDA1OTk3LCA1MDksIDQ2MzU5LCAzNzAsIDAsIDM2MDAwMDBdXTtcbiAgICAgIG1vY2tzLmRyaXZlci5leHBlY3RzKCdnZXRQZXJmb3JtYW5jZURhdGEnKS53aXRoRXhhY3RBcmdzKCdpby5hcHBpdW0uYW5kcm9pZC5hcGlzJywgJ25ldHdvcmtpbmZvJywgMTAwMCkucmV0dXJucyhyZXR1cm5WYWx1ZSk7XG4gICAgICBsZXQgbmV0d29yayA9IGRyaXZlci5nZXRQZXJmb3JtYW5jZURhdGEoJ2lvLmFwcGl1bS5hbmRyb2lkLmFwaXMnLCAnbmV0d29ya2luZm8nLCAxMDAwKTtcbiAgICAgIG5ldHdvcmsubGVuZ3RoLnNob3VsZC5iZS5hYm92ZSgwKTtcbiAgICAgIGxldCBjb21wYXJlID0gZmFsc2U7XG5cbiAgICAgIGZvciAoIGxldCBqPSAwIDsgaiA8IE5FVFdPUktfS0VZUy5sZW5ndGggOyArKyBqKXtcbiAgICAgICAgaWYgKF8uaXNFcXVhbCggTkVUV09SS19LRVlTW2pdLCBuZXR3b3JrWzBdKSl7XG4gICAgICAgICAgY29tcGFyZSA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY29tcGFyZS5zaG91bGQuZXF1YWwodHJ1ZSk7XG5cbiAgICAgIGlmIChuZXR3b3JrLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBuZXR3b3JrLmxlbmd0aDsgKytpKXtcbiAgICAgICAgICBuZXR3b3JrWzBdLmxlbmd0aC5zaG91bGQuZXF1YWwobmV0d29ya1tpXS5sZW5ndGgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xufSkpO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLiJ9
